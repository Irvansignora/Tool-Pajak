<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PajakTools ‚Äî Suite Lengkap Alat Pajak Indonesia</title>
    <link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=IBM+Plex+Mono:wght@400;500;600&family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --bg: #080c14;
            --surface: #0e1520;
            --surface2: #141d2c;
            --border: #1e2d42;
            --border2: #263548;
            --text: #e2eaf8;
            --text-dim: #6b83a3;
            --text-muted: #3d5270;
            --accent: #3b82f6;
            --accent2: #60a5fa;
            --green: #10b981;
            --yellow: #f59e0b;
            --pink: #ec4899;
            --cyan: #06b6d4;
            --orange: #f97316;
            --purple: #8b5cf6;
            --tab-active: #3b82f6;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        html { scroll-behavior: smooth; }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* ‚îÄ‚îÄ Background ‚îÄ‚îÄ */
        body::before {
            content: '';
            position: fixed;
            inset: 0;
            background:
                radial-gradient(ellipse 80% 50% at 10% 0%, rgba(59,130,246,0.07) 0%, transparent 60%),
                radial-gradient(ellipse 60% 40% at 90% 100%, rgba(139,92,246,0.06) 0%, transparent 55%),
                radial-gradient(ellipse 50% 60% at 50% 50%, rgba(6,182,212,0.03) 0%, transparent 70%);
            pointer-events: none;
            z-index: 0;
        }

        /* ‚îÄ‚îÄ Navbar ‚îÄ‚îÄ */
        .navbar {
            position: sticky;
            top: 0;
            z-index: 100;
            background: rgba(8,12,20,0.85);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border);
            padding: 0 32px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 64px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            text-decoration: none;
        }

        .logo-icon {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, var(--accent), var(--purple));
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: 800;
            color: white;
            font-family: 'Syne', sans-serif;
        }

        .logo-text {
            font-family: 'Syne', sans-serif;
            font-size: 20px;
            font-weight: 800;
            color: var(--text);
            letter-spacing: -0.5px;
        }

        .logo-text span { color: var(--accent2); }

        .navbar-meta {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 11px;
            color: var(--text-muted);
            letter-spacing: 0.05em;
        }

        /* ‚îÄ‚îÄ Hero ‚îÄ‚îÄ */
        .hero {
            position: relative;
            z-index: 1;
            text-align: center;
            padding: 72px 32px 56px;
        }

        .hero-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 14px;
            background: rgba(59,130,246,0.1);
            border: 1px solid rgba(59,130,246,0.3);
            border-radius: 100px;
            font-size: 11px;
            font-family: 'IBM Plex Mono', monospace;
            color: var(--accent2);
            letter-spacing: 0.08em;
            text-transform: uppercase;
            margin-bottom: 24px;
        }

        .hero h1 {
            font-family: 'Syne', sans-serif;
            font-size: clamp(36px, 6vw, 64px);
            font-weight: 800;
            line-height: 1.05;
            letter-spacing: -1.5px;
            color: var(--text);
            margin-bottom: 20px;
        }

        .hero h1 .gradient-text {
            background: linear-gradient(135deg, var(--accent2) 0%, var(--cyan) 50%, var(--purple) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .hero p {
            font-size: 17px;
            color: var(--text-dim);
            max-width: 520px;
            margin: 0 auto 40px;
            line-height: 1.7;
        }

        .hero-stats {
            display: flex;
            justify-content: center;
            gap: 48px;
            flex-wrap: wrap;
        }

        .hero-stat {
            text-align: center;
        }

        .hero-stat-num {
            font-family: 'Syne', sans-serif;
            font-size: 32px;
            font-weight: 800;
            color: var(--text);
            line-height: 1;
        }

        .hero-stat-label {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 4px;
            font-family: 'IBM Plex Mono', monospace;
            letter-spacing: 0.04em;
        }

        /* ‚îÄ‚îÄ Tab Navigation ‚îÄ‚îÄ */
        .tabs-wrapper {
            position: relative;
            z-index: 1;
            padding: 0 32px;
            margin-bottom: 32px;
        }

        .tabs-container {
            display: flex;
            gap: 4px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 6px;
            max-width: 900px;
            margin: 0 auto;
            flex-wrap: wrap;
        }

        .tab-btn {
            flex: 1;
            min-width: 140px;
            padding: 12px 16px;
            border: none;
            border-radius: 10px;
            background: transparent;
            color: var(--text-dim);
            font-size: 13px;
            font-weight: 600;
            font-family: 'Plus Jakarta Sans', sans-serif;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }

        .tab-btn .tab-icon { font-size: 18px; }
        .tab-btn .tab-label { white-space: nowrap; }
        .tab-btn .tab-tag {
            font-size: 9px;
            font-family: 'IBM Plex Mono', monospace;
            letter-spacing: 0.06em;
            opacity: 0.7;
        }

        .tab-btn:hover { color: var(--text); background: var(--surface2); }

        .tab-btn.active {
            background: linear-gradient(135deg, rgba(59,130,246,0.2), rgba(139,92,246,0.15));
            color: var(--accent2);
            border: 1px solid rgba(59,130,246,0.3);
        }

        .tab-btn.active .tab-tag { opacity: 1; color: var(--accent); }

        /* ‚îÄ‚îÄ Main content area ‚îÄ‚îÄ */
        .main {
            position: relative;
            z-index: 1;
            max-width: 1000px;
            margin: 0 auto;
            padding: 0 32px 80px;
        }

        .tool-panel {
            display: none;
            animation: panelIn 0.35s ease;
        }

        .tool-panel.active { display: block; }

        @keyframes panelIn {
            from { opacity: 0; transform: translateY(16px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ‚îÄ‚îÄ Tool Card ‚îÄ‚îÄ */
        .tool-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 28px;
            margin-bottom: 20px;
        }

        .tool-card-header {
            display: flex;
            align-items: center;
            gap: 14px;
            margin-bottom: 24px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border);
        }

        .tool-card-icon {
            width: 48px;
            height: 48px;
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            flex-shrink: 0;
        }

        .tool-card-title {
            font-family: 'Syne', sans-serif;
            font-size: 20px;
            font-weight: 700;
            color: var(--text);
            line-height: 1.2;
        }

        .tool-card-desc {
            font-size: 13px;
            color: var(--text-dim);
            margin-top: 2px;
        }

        /* ‚îÄ‚îÄ Upload Area ‚îÄ‚îÄ */
        .upload-area {
            border: 2px dashed var(--border2);
            border-radius: 14px;
            padding: 40px 32px;
            text-align: center;
            cursor: pointer;
            transition: all 0.25s;
            background: rgba(255,255,255,0.02);
            margin-bottom: 20px;
        }

        .upload-area:hover, .upload-area.dragover {
            border-color: var(--accent);
            background: rgba(59,130,246,0.06);
        }

        .upload-area.success {
            border-color: var(--green);
            background: rgba(16,185,129,0.06);
        }

        .upload-icon { font-size: 40px; margin-bottom: 12px; display: block; }
        .upload-title { font-size: 16px; font-weight: 600; color: var(--text); margin-bottom: 6px; }
        .upload-sub { font-size: 13px; color: var(--text-dim); }

        input[type="file"] { display: none; }

        /* ‚îÄ‚îÄ Buttons ‚îÄ‚îÄ */
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 12px 24px;
            border-radius: 10px;
            border: none;
            font-size: 14px;
            font-weight: 600;
            font-family: 'Plus Jakarta Sans', sans-serif;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent), #2563eb);
            color: white;
            box-shadow: 0 4px 20px rgba(59,130,246,0.35);
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 28px rgba(59,130,246,0.5);
        }

        .btn-primary:disabled { opacity: 0.35; cursor: not-allowed; }

        .btn-green {
            background: linear-gradient(135deg, var(--green), #059669);
            color: white;
            box-shadow: 0 4px 16px rgba(16,185,129,0.3);
        }

        .btn-green:hover { transform: translateY(-2px); box-shadow: 0 6px 24px rgba(16,185,129,0.45); }

        .btn-yellow {
            background: linear-gradient(135deg, var(--yellow), #d97706);
            color: white;
        }

        .btn-yellow:hover { transform: translateY(-2px); }

        .btn-teal {
            background: linear-gradient(135deg, var(--cyan), #0891b2);
            color: white;
        }

        .btn-teal:hover { transform: translateY(-2px); }

        .btn-red {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
        }

        .btn-row {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }

        /* ‚îÄ‚îÄ Form Elements ‚îÄ‚îÄ */
        .form-group { margin-bottom: 18px; }

        .form-label {
            display: block;
            font-size: 12px;
            font-weight: 600;
            letter-spacing: 0.06em;
            text-transform: uppercase;
            color: var(--text-dim);
            font-family: 'IBM Plex Mono', monospace;
            margin-bottom: 8px;
        }

        .form-input, .form-select {
            width: 100%;
            padding: 12px 14px;
            background: var(--bg);
            border: 1px solid var(--border2);
            border-radius: 8px;
            color: var(--text);
            font-size: 14px;
            font-family: 'IBM Plex Mono', monospace;
            transition: all 0.2s;
            outline: none;
        }

        .form-input:focus, .form-select:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(59,130,246,0.12);
        }

        .form-select {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath fill='%236b83a3' d='M6 8L0 0h12z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 14px center;
            padding-right: 36px;
            cursor: pointer;
        }

        /* ‚îÄ‚îÄ Result Box ‚îÄ‚îÄ */
        .result-box {
            background: rgba(0,0,0,0.3);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 18px;
            max-height: 380px;
            overflow: auto;
            font-family: 'IBM Plex Mono', monospace;
            font-size: 12px;
            white-space: pre-wrap;
            word-break: break-all;
            color: #86efac;
            line-height: 1.7;
        }

        .result-box::-webkit-scrollbar { width: 5px; height: 5px; }
        .result-box::-webkit-scrollbar-track { background: transparent; }
        .result-box::-webkit-scrollbar-thumb { background: var(--border2); border-radius: 3px; }

        /* ‚îÄ‚îÄ Company Cards ‚îÄ‚îÄ */
        .company-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 10px;
            margin-bottom: 8px;
        }

        .company-card {
            cursor: pointer;
            border-radius: 12px;
            padding: 14px 16px;
            border: 1px solid var(--border2);
            background: var(--bg);
            transition: all 0.2s;
            user-select: none;
        }

        .company-card:hover {
            border-color: rgba(59,130,246,0.5);
            background: rgba(59,130,246,0.06);
        }

        .company-card.active {
            border-color: var(--accent);
            background: rgba(59,130,246,0.12);
            box-shadow: 0 0 20px rgba(59,130,246,0.2);
        }

        .company-name {
            font-size: 15px;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 3px;
        }

        .company-npwp {
            font-size: 10px;
            color: var(--text-muted);
            font-family: 'IBM Plex Mono', monospace;
        }

        .company-card.active .company-npwp { color: var(--accent2); }

        .active-badge {
            display: none;
            margin-top: 12px;
            padding: 9px 14px;
            background: rgba(16,185,129,0.1);
            border: 1px solid rgba(16,185,129,0.3);
            border-radius: 8px;
            color: var(--green);
            font-size: 13px;
            font-weight: 600;
            align-items: center;
            gap: 8px;
            font-family: 'IBM Plex Mono', monospace;
        }

        .active-badge.show { display: flex; }

        /* ‚îÄ‚îÄ Gross Up Calculator Grid ‚îÄ‚îÄ */
        .calc-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 16px;
        }

        .calc-card {
            background: var(--bg);
            border: 1px solid var(--border2);
            border-radius: 14px;
            padding: 22px;
            position: relative;
            overflow: hidden;
            transition: all 0.25s;
        }

        .calc-card::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 3px;
            background: var(--card-color);
            opacity: 0;
            transition: opacity 0.3s;
        }

        .calc-card:hover { border-color: var(--card-color); transform: translateY(-3px); }
        .calc-card:hover::before { opacity: 1; }
        .calc-card.pph21 { --card-color: var(--cyan); }
        .calc-card.pph23 { --card-color: var(--pink); }
        .calc-card.pph4  { --card-color: var(--yellow); }
        .calc-card.ppn   { --card-color: var(--orange); }

        .calc-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 18px;
            padding-bottom: 14px;
            border-bottom: 1px solid var(--border);
        }

        .calc-card-title {
            font-family: 'Syne', sans-serif;
            font-size: 18px;
            font-weight: 700;
            color: var(--card-color);
        }

        .calc-badge {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 10px;
            padding: 3px 10px;
            background: var(--card-color);
            color: #000;
            border-radius: 4px;
            font-weight: 600;
            letter-spacing: 0.06em;
        }

        .calc-btn {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            background: var(--card-color);
            color: #000;
            font-size: 13px;
            font-weight: 700;
            font-family: 'IBM Plex Mono', monospace;
            cursor: pointer;
            transition: all 0.2s;
            letter-spacing: 0.04em;
            text-transform: uppercase;
            margin-top: 4px;
        }

        .calc-btn:hover { filter: brightness(1.15); transform: translateY(-2px); }

        .calc-result {
            margin-top: 18px;
            padding: 16px;
            background: rgba(0,0,0,0.3);
            border-left: 3px solid var(--card-color);
            border-radius: 4px;
            opacity: 0;
            transform: translateY(12px);
            transition: all 0.3s;
        }

        .calc-result.show { opacity: 1; transform: translateY(0); }

        .result-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 9px 0;
            border-bottom: 1px solid var(--border);
            font-family: 'IBM Plex Mono', monospace;
        }

        .result-row:last-child {
            border-bottom: none;
            padding-top: 12px;
            border-top: 2px solid var(--card-color);
            margin-top: 4px;
        }

        .result-label { font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.04em; }
        .result-value { font-size: 13px; font-weight: 600; color: var(--text); }
        .result-row:last-child .result-value { font-size: 15px; color: var(--card-color); }

        /* ‚îÄ‚îÄ Mode Toggle ‚îÄ‚îÄ */
        .mode-toggle {
            display: flex;
            background: var(--bg);
            border: 1px solid var(--border2);
            border-radius: 12px;
            padding: 4px;
            margin-bottom: 24px;
            gap: 4px;
        }

        .mode-btn {
            flex: 1;
            padding: 10px 16px;
            border: none;
            border-radius: 8px;
            background: transparent;
            color: var(--text-dim);
            font-size: 13px;
            font-weight: 600;
            font-family: 'Plus Jakarta Sans', sans-serif;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 7px;
        }

        .mode-btn:hover { color: var(--text); background: var(--surface2); }

        .mode-btn.active {
            background: linear-gradient(135deg, rgba(59,130,246,0.22), rgba(139,92,246,0.15));
            color: var(--accent2);
            border: 1px solid rgba(59,130,246,0.35);
        }

        .mode-desc {
            font-size: 12px;
            color: var(--text-muted);
            text-align: center;
            margin-bottom: 20px;
            font-family: 'IBM Plex Mono', monospace;
            padding: 8px 14px;
            background: rgba(59,130,246,0.05);
            border-radius: 8px;
            border: 1px solid rgba(59,130,246,0.1);
            line-height: 1.6;
        }

        /* ‚îÄ‚îÄ Kalkulator Biasa extra styles ‚îÄ‚îÄ */
        .kb-calc-card {
            background: var(--bg);
            border: 1px solid var(--border2);
            border-radius: 14px;
            padding: 22px;
            position: relative;
            overflow: hidden;
            transition: all 0.25s;
        }

        .kb-calc-card::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 3px;
            background: var(--card-color);
            opacity: 0;
            transition: opacity 0.3s;
        }

        .kb-calc-card:hover { border-color: var(--card-color); transform: translateY(-3px); }
        .kb-calc-card:hover::before { opacity: 1; }
        .kb-calc-card.pph21 { --card-color: var(--cyan); }
        .kb-calc-card.pph23 { --card-color: var(--pink); }
        .kb-calc-card.pph4  { --card-color: var(--yellow); }
        .kb-calc-card.ppn   { --card-color: var(--orange); }
        .kb-calc-card.pph22 { --card-color: var(--purple); }

        .kb-result-highlight {
            background: rgba(0,0,0,0.35);
            border-left: 3px solid var(--card-color);
            border-radius: 4px;
            padding: 14px 16px;
        }

        /* ‚îÄ‚îÄ Info cards ‚îÄ‚îÄ */
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 12px;
            margin-top: 20px;
        }

        .info-card {
            padding: 18px;
            background: var(--bg);
            border-left: 3px solid var(--info-color);
            border-radius: 4px;
        }

        .info-card h3 {
            font-size: 14px;
            font-weight: 700;
            color: var(--info-color);
            font-family: 'IBM Plex Mono', monospace;
            margin-bottom: 8px;
        }

        .info-card p { font-size: 12px; color: var(--text-dim); line-height: 1.6; }
        .info-card.pph21 { --info-color: var(--cyan); }
        .info-card.pph23 { --info-color: var(--pink); }
        .info-card.pph4  { --info-color: var(--yellow); }
        .info-card.ppn   { --info-color: var(--orange); }

        /* ‚îÄ‚îÄ Progress ‚îÄ‚îÄ */
        .progress-wrap { display: none; margin: 16px 0; }
        .progress-bar { width: 100%; height: 6px; background: var(--border); border-radius: 3px; overflow: hidden; }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent), var(--cyan));
            width: 0%;
            transition: width 0.3s;
            border-radius: 3px;
        }
        .progress-text { text-align: center; margin-top: 8px; font-size: 13px; color: var(--text-dim); font-family: 'IBM Plex Mono', monospace; }

        /* ‚îÄ‚îÄ File list ‚îÄ‚îÄ */
        .file-list-wrap { display: none; margin: 14px 0; }
        .file-list-title { font-size: 12px; font-weight: 600; color: var(--text-dim); margin-bottom: 8px; font-family: 'IBM Plex Mono', monospace; }
        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 14px;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            margin: 6px 0;
        }
        .file-item-info { flex: 1; }
        .file-item-name { font-size: 13px; font-weight: 600; color: var(--text); }
        .file-item-size { font-size: 11px; color: var(--text-dim); font-family: 'IBM Plex Mono', monospace; }
        .file-remove-btn {
            background: rgba(239,68,68,0.15);
            border: 1px solid rgba(239,68,68,0.3);
            color: #f87171;
            border-radius: 6px;
            padding: 4px 10px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .file-remove-btn:hover { background: rgba(239,68,68,0.3); }

        /* ‚îÄ‚îÄ Options panel ‚îÄ‚îÄ */
        .options-panel {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 18px;
            margin: 14px 0;
        }

        .options-title { font-size: 12px; font-weight: 600; color: var(--text-dim); margin-bottom: 12px; font-family: 'IBM Plex Mono', monospace; letter-spacing: 0.04em; text-transform: uppercase; }

        .option-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 8px 0;
        }

        .option-item input[type="checkbox"] {
            width: 15px; height: 15px;
            accent-color: var(--accent);
            cursor: pointer;
        }

        .option-item label { font-size: 13px; color: var(--text-dim); cursor: pointer; }

        /* ‚îÄ‚îÄ Result area ‚îÄ‚îÄ */
        .result-area {
            display: none;
            margin-top: 16px;
            padding: 20px;
            background: rgba(16,185,129,0.05);
            border: 1px solid rgba(16,185,129,0.2);
            border-radius: 12px;
        }

        .result-area-title { font-size: 15px; font-weight: 700; color: var(--green); margin-bottom: 14px; }

        .preview-table-wrap { overflow-x: auto; border-radius: 10px; margin: 14px 0; }

        .preview-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
            background: var(--bg);
        }

        .preview-table th {
            background: linear-gradient(135deg, #1e3a5f, #263548);
            color: var(--accent2);
            padding: 10px 12px;
            text-align: left;
            font-family: 'IBM Plex Mono', monospace;
            font-size: 10px;
            letter-spacing: 0.04em;
            text-transform: uppercase;
            white-space: nowrap;
            position: sticky;
            top: 0;
        }

        .preview-table td {
            padding: 9px 12px;
            border-bottom: 1px solid var(--border);
            color: var(--text);
            white-space: nowrap;
        }

        .preview-table tr:hover td { background: rgba(59,130,246,0.04); }

        /* ‚îÄ‚îÄ Faktur pajak result table ‚îÄ‚îÄ */
        .fp-table-wrap { overflow-x: auto; border-radius: 12px; margin-top: 16px; border: 1px solid var(--border); }

        .fp-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
            background: var(--bg);
        }

        .fp-table th {
            background: linear-gradient(135deg, #1a2d4a, #1e3a5f);
            color: var(--accent2);
            padding: 12px 14px;
            text-align: left;
            font-family: 'IBM Plex Mono', monospace;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.04em;
            position: sticky;
            top: 0;
        }

        .fp-table td {
            padding: 10px 14px;
            border-bottom: 1px solid var(--border);
            color: var(--text);
        }

        .fp-table tr:hover td { background: rgba(59,130,246,0.04); }

        /* ‚îÄ‚îÄ Error ‚îÄ‚îÄ */
        .error-box {
            display: none;
            margin-top: 14px;
            padding: 16px;
            background: rgba(239,68,68,0.08);
            border: 1px solid rgba(239,68,68,0.25);
            border-radius: 10px;
            color: #f87171;
            font-size: 13px;
            font-family: 'IBM Plex Mono', monospace;
        }

        /* ‚îÄ‚îÄ Section label ‚îÄ‚îÄ */
        .section-label {
            font-size: 11px;
            font-weight: 700;
            letter-spacing: 0.1em;
            text-transform: uppercase;
            color: var(--text-muted);
            font-family: 'IBM Plex Mono', monospace;
            margin-bottom: 10px;
        }

        /* ‚îÄ‚îÄ Footer ‚îÄ‚îÄ */
        .footer {
            text-align: center;
            padding: 24px;
            color: var(--text-muted);
            font-size: 12px;
            font-family: 'IBM Plex Mono', monospace;
            border-top: 1px solid var(--border);
        }

        /* ‚îÄ‚îÄ Responsive ‚îÄ‚îÄ */
        @media (max-width: 768px) {
            .hero h1 { font-size: 32px; letter-spacing: -0.5px; }
            .navbar { padding: 0 16px; }
            .tabs-wrapper { padding: 0 16px; }
            .main { padding: 0 16px 60px; }
            .hero { padding: 48px 16px 40px; }
            .hero-stats { gap: 28px; }
            .tab-btn { min-width: 100px; font-size: 11px; }
            .calc-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

<!-- Navbar -->
<nav class="navbar">
    <div class="logo">
        <div class="logo-icon">P</div>
        <span class="logo-text">Pajak<span>Tools</span></span>
    </div>
    <div class="navbar-meta">Suite Alat Pajak Indonesia</div>
</nav>

<!-- Hero -->
<section class="hero">
    <div class="hero-badge">üáÆüá© Indonesia Tax Suite</div>
    <h1>Semua Alat Pajak<br>di <span class="gradient-text">Satu Tempat</span></h1>
    <p>Platform lengkap untuk kebutuhan perpajakan Indonesia ‚Äî konversi PDF, generate XML Coretax, kalkulator Pajak, dan lebih banyak lagi.</p>
    <div class="hero-stats">
        <div class="hero-stat">
            <div class="hero-stat-num">5</div>
            <div class="hero-stat-label">Fitur Tools</div>
        </div>
        <div class="hero-stat">
            <div class="hero-stat-num">100%</div>
            <div class="hero-stat-label">Client-Side</div>
        </div>
        <div class="hero-stat">
            <div class="hero-stat-num">0</div>
            <div class="hero-stat-label">Data Upload</div>
        </div>
    </div>
</section>

<!-- Tab Navigation -->
<div class="tabs-wrapper">
    <div class="tabs-container">
        <button class="tab-btn active" onclick="switchTab('xml')">
            <span class="tab-icon">üîÑ</span>
            <span class="tab-label">Excel ‚Üí XML</span>
            <span class="tab-tag">CORETAX</span>
        </button>
        <button class="tab-btn" onclick="switchTab('grossup')">
            <span class="tab-icon">üßÆ</span>
            <span class="tab-label">Kalkulator Pajak</span>
            <span class="tab-tag">PPH/PPN</span>
        </button>
        <button class="tab-btn" onclick="switchTab('pph21')">
            <span class="tab-icon">üìä</span>
            <span class="tab-label">PPh21</span>
            <span class="tab-tag">PDF ‚Üí EXCEL</span>
        </button>
        <button class="tab-btn" onclick="switchTab('bppu')">
            <span class="tab-icon">üìë</span>
            <span class="tab-label">PPh Unifikasi</span>
            <span class="tab-tag">PDF ‚Üí EXCEL</span>
        </button>
        <button class="tab-btn" onclick="switchTab('faktur')">
            <span class="tab-icon">üßæ</span>
            <span class="tab-label">Faktur Pajak</span>
            <span class="tab-tag">PDF‚ÜíEXCEL</span>
        </button>
    </div>
</div>

<!-- Main Content -->
<div class="main">

    <!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ TAB 1: Excel ‚Üí XML Coretax ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
    <div id="tab-xml" class="tool-panel active">
        <div class="tool-card">
            <div class="tool-card-header">
                <div class="tool-card-icon" style="background:linear-gradient(135deg,rgba(59,130,246,0.2),rgba(139,92,246,0.15));border:1px solid rgba(59,130,246,0.3)">üîÑ</div>
                <div>
                    <div class="tool-card-title">Excel to Tax Invoice XML</div>
                    <div class="tool-card-desc">Konversi data Excel ke format XML Faktur Pajak Coretax ¬∑ Multi Perusahaan</div>
                </div>
            </div>

            <!-- Company Selector -->
            <div class="section-label">Pilih Perusahaan</div>
            <div class="company-grid">
                <div class="company-card" data-company="RDTN" data-tin="0991183559012000" data-idtku="0991183559012000000000" onclick="xmlSelectCompany(this)">
                    <div class="company-name">üîµ RDTN</div>
                    <div class="company-npwp">099118355-9012-000</div>
                </div>
                <div class="company-card" data-company="SNB" data-tin="0014602601904000" data-idtku="0014602601904000000000" onclick="xmlSelectCompany(this)">
                    <div class="company-name">üü¢ SNB</div>
                    <div class="company-npwp">001460260-1904-000</div>
                </div>
                <div class="company-card" data-company="UDN" data-tin="0018852632007000" data-idtku="0018852632007000000000" onclick="xmlSelectCompany(this)">
                    <div class="company-name">üü† UDN</div>
                    <div class="company-npwp">001885263-2007-000</div>
                </div>
                <div class="company-card" data-company="USI" data-tin="0837291145048000" data-idtku="0837291145048000000000" onclick="xmlSelectCompany(this)">
                    <div class="company-name">üî¥ USI</div>
                    <div class="company-npwp">083729114-5048-000</div>
                </div>
                <!-- Custom NPWP Card -->
                <div class="company-card" id="xmlCustomCard" data-company="CUSTOM" data-tin="" data-idtku="" onclick="xmlSelectCompany(this)">
                    <div class="company-name">‚úèÔ∏è Custom</div>
                    <div class="company-npwp" id="xmlCustomCardNpwp">Klik untuk isi NPWP</div>
                </div>
            </div>

            <!-- Custom NPWP Input (muncul saat card Custom dipilih) -->
            <div id="xmlCustomInputWrap" style="display:none;margin-top:14px;background:rgba(59,130,246,0.06);border:1px solid rgba(59,130,246,0.2);border-radius:12px;padding:16px;">
                <div style="font-family:'IBM Plex Mono',monospace;font-size:11px;letter-spacing:0.08em;text-transform:uppercase;color:var(--text-muted);margin-bottom:12px;">‚úèÔ∏è Input NPWP Custom</div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
                    <div class="form-group" style="margin-bottom:0;">
                        <label class="form-label">Nama Perusahaan</label>
                        <input type="text" class="form-input" id="xmlCustomName" placeholder="Contoh: PT Maju Jaya" oninput="xmlUpdateCustom()">
                    </div>
                    <div class="form-group" style="margin-bottom:0;">
                        <label class="form-label">NPWP / TIN (16 digit angka)</label>
                        <input type="text" class="form-input" id="xmlCustomNpwp" placeholder="Contoh: 0123456789012000" maxlength="16" inputmode="numeric" oninput="xmlUpdateCustom()">
                    </div>
                </div>
                <div id="xmlCustomValidation" style="margin-top:8px;font-size:11px;font-family:'IBM Plex Mono',monospace;color:var(--text-muted);"></div>
            </div>

            <div class="active-badge" id="xmlActiveBadge">
                <span>‚úÖ</span><span id="xmlActiveBadgeText">‚Äì</span>
            </div>

            <div style="margin-top:20px;"></div>

            <!-- Download Template -->
            <div class="btn-row" style="margin-bottom:16px;">
                <button class="btn btn-yellow" onclick="xmlDownloadTemplate()">üì• Download Template Excel</button>
            </div>

            <!-- Upload -->
            <div class="upload-area" id="xmlUploadArea">
                <span class="upload-icon">üì§</span>
                <div class="upload-title">Klik atau Drag & Drop File Excel</div>
                <div class="upload-sub">Support: .xlsx, .xls</div>
                <input type="file" id="xmlFileInput" accept=".xlsx,.xls">
            </div>

            <!-- Buttons -->
            <div class="btn-row">
                <button class="btn btn-primary" id="xmlConvertBtn" disabled>‚ö° Convert ke XML</button>
                <button class="btn btn-green" id="xmlDownloadBtn" style="display:none;">üíæ Download XML</button>
                <button class="btn btn-teal" id="xmlCopyBtn" style="display:none;">üìã Copy XML</button>
            </div>

            <!-- Preview -->
            <div id="xmlPreview" style="display:none;margin-top:20px;">
                <div class="section-label" style="margin-bottom:8px;">Preview XML</div>
                <div class="result-box" id="xmlPreviewBox"></div>
            </div>
        </div>
    </div>

    <!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ TAB 2: Kalkulator Pajak ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
    <div id="tab-grossup" class="tool-panel">
        <div class="tool-card">
            <div class="tool-card-header">
                <div class="tool-card-icon" style="background:linear-gradient(135deg,rgba(16,185,129,0.15),rgba(6,182,212,0.1));border:1px solid rgba(16,185,129,0.3)">üßÆ</div>
                <div>
                    <div class="tool-card-title">Kalkulator Pajak</div>
                    <div class="tool-card-desc">Hitung PPh & PPN ‚Äî mode biasa (dari DPP/bruto) atau mode gross up (dari nett)</div>
                </div>
            </div>

            <!-- Mode Toggle -->
            <div class="mode-toggle">
                <button class="mode-btn active" id="modeBtnBiasa" onclick="switchCalcMode('biasa')">
                    üßæ Hitung Pajak Biasa
                </button>
                <button class="mode-btn" id="modeBtnGrossup" onclick="switchCalcMode('grossup')">
                    üìà Gross Up
                </button>
                <button class="mode-btn" id="modeBtnProgresif" onclick="switchCalcMode('progresif')">
                    üìä PPh 21 Progresif
                </button>
                <button class="mode-btn" id="modeBtnImport" onclick="switchCalcMode('import')">
                    üì• Import Excel
                </button>
            </div>

            <!-- ‚ïê‚ïê MODE BIASA ‚ïê‚ïê -->
            <div id="calcModeBiasa">
                <div class="mode-desc">
                    üí° <strong>Mode Hitung Biasa</strong> ‚Äî Masukkan nilai DPP/Bruto, langsung dapat berapa pajaknya yang harus dipotong/dipungut
                </div>

                <div class="calc-grid">

                    <!-- PPh 21 Biasa -->
                    <div class="kb-calc-card pph21">
                        <div class="calc-card-header">
                            <div class="calc-card-title">PPh 21</div>
                            <span class="calc-badge">PASAL 21</span>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Mode Perhitungan</label>
                            <select class="form-select" id="kb_modePPh21" onchange="kbToggleModePPh21()">
                                <option value="ter">üìÖ TER Bulanan (PP 58/2023)</option>
                                <option value="tetap">üìã Tarif Tetap (Final/Tdk Final)</option>
                            </select>
                        </div>
                        <!-- TER group -->
                        <div id="kb_ter_group">
                            <div class="form-group">
                                <label class="form-label">Kategori PTKP</label>
                                <select class="form-select" id="kb_terKategori">
                                    <optgroup label="‚îÄ‚îÄ Kategori A ‚îÄ‚îÄ">
                                        <option value="A">TK/0 ‚Äî Lajang, tanpa tanggungan</option>
                                        <option value="A">TK/1 ‚Äî Lajang, 1 tanggungan</option>
                                        <option value="A">K/0 ‚Äî Kawin, 0 tanggungan</option>
                                    </optgroup>
                                    <optgroup label="‚îÄ‚îÄ Kategori B ‚îÄ‚îÄ">
                                        <option value="B">TK/2 ‚Äî Lajang, 2 tanggungan</option>
                                        <option value="B">TK/3 ‚Äî Lajang, 3 tanggungan</option>
                                        <option value="B">K/1 ‚Äî Kawin, 1 tanggungan</option>
                                        <option value="B">K/2 ‚Äî Kawin, 2 tanggungan</option>
                                    </optgroup>
                                    <optgroup label="‚îÄ‚îÄ Kategori C ‚îÄ‚îÄ">
                                        <option value="C">K/3 ‚Äî Kawin, 3 tanggungan</option>
                                    </optgroup>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Penghasilan Bruto Sebulan (Rp)</label>
                                <input type="text" class="form-input" id="kb_ter_bruto" placeholder="0" inputmode="decimal">
                            </div>
                        </div>
                        <!-- Tarif tetap group -->
                        <div id="kb_tetap_group" style="display:none;">
                            <div class="form-group">
                                <label class="form-label">Tarif Pajak (%)</label>
                                <select class="form-select" id="kb_tarifPPh21">
                                    <option value="0.5">0.5% ‚Äî Final</option>
                                    <option value="2.5">2.5% ‚Äî Tidak Final</option>
                                    <option value="5">5% ‚Äî Tidak Ber-NPWP</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">DPP / Penghasilan Bruto (Rp)</label>
                                <input type="text" class="form-input" id="kb_dppPPh21" placeholder="0" inputmode="decimal">
                            </div>
                        </div>
                        <button class="calc-btn" onclick="kbHitungPPh21()">Hitung PPh 21</button>
                        <div id="kb_resultPPh21" class="calc-result"></div>
                    </div>

                    <!-- PPh 23 Biasa -->
                    <div class="kb-calc-card pph23">
                        <div class="calc-card-header">
                            <div class="calc-card-title">PPh 23</div>
                            <span class="calc-badge">PASAL 23</span>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Jenis Penghasilan</label>
                            <select class="form-select" id="kb_jenisPPh23" onchange="kbUpdatePPh23()">
                                <option value="2">Dividen, Bunga, Royalti (2%)</option>
                                <option value="2b">Jasa Teknik, Manajemen (2%)</option>
                                <option value="2c">Sewa & Penghasilan Lain (2%)</option>
                                <option value="custom">Custom Tarif</option>
                            </select>
                        </div>
                        <div class="form-group" id="kb_customTarifPPh23Group" style="display:none;">
                            <label class="form-label">Tarif Custom (%)</label>
                            <input type="number" class="form-input" id="kb_customTarifPPh23" placeholder="0" min="0" max="100" step="0.1">
                        </div>
                        <div class="form-group">
                            <label class="form-label">DPP / Nilai Bruto (Rp)</label>
                            <input type="text" class="form-input" id="kb_dppPPh23" placeholder="0" inputmode="decimal">
                        </div>
                        <button class="calc-btn" onclick="kbHitungPPh23()">Hitung PPh 23</button>
                        <div id="kb_resultPPh23" class="calc-result"></div>
                    </div>

                    <!-- PPh 4(2) Biasa -->
                    <div class="kb-calc-card pph4">
                        <div class="calc-card-header">
                            <div class="calc-card-title">PPh 4(2)</div>
                            <span class="calc-badge">FINAL</span>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Jenis Penghasilan</label>
                            <select class="form-select" id="kb_jenisPPh4" onchange="kbUpdatePPh4()">
                                <option value="10">Sewa Tanah/Bangunan (10%)</option>
                                <option value="20">Bunga Deposito/Tabungan (20%)</option>
                                <optgroup label="A. Pelaksanaan Konstruksi">
                                    <option value="1.75">Kualifikasi Kecil/OP Bersertifikat (1.75%)</option>
                                    <option value="2.65">Menengah & Besar Bersertifikat (2.65%)</option>
                                    <option value="4">Tidak Punya Sertifikat SBU/SKK (4%)</option>
                                </optgroup>
                                <optgroup label="B. Perencanaan & Pengawasan">
                                    <option value="3.5">Punya Sertifikat (3.5%)</option>
                                    <option value="6">Tidak Punya Sertifikat (6%)</option>
                                </optgroup>
                                <optgroup label="C. Konstruksi Terintegrasi">
                                    <option value="2.65">Bersertifikat (2.65%)</option>
                                    <option value="4">Tidak Bersertifikat (4%)</option>
                                </optgroup>
                                <option value="2.5">Pengalihan Hak Tanah/Bangunan (2.5%)</option>
                                <option value="custom">Custom Tarif</option>
                            </select>
                        </div>
                        <div class="form-group" id="kb_customTarifPPh4Group" style="display:none;">
                            <label class="form-label">Tarif Custom (%)</label>
                            <input type="number" class="form-input" id="kb_customTarifPPh4" placeholder="0" min="0" max="100" step="0.1">
                        </div>
                        <div class="form-group">
                            <label class="form-label">DPP / Nilai Bruto (Rp)</label>
                            <input type="text" class="form-input" id="kb_dppPPh4" placeholder="0" inputmode="decimal">
                        </div>
                        <button class="calc-btn" onclick="kbHitungPPh4()">Hitung PPh 4(2)</button>
                        <div id="kb_resultPPh4" class="calc-result"></div>
                    </div>

                    <!-- PPh 22 Biasa -->
                    <div class="kb-calc-card pph22">
                        <div class="calc-card-header">
                            <div class="calc-card-title">PPh 22</div>
                            <span class="calc-badge">PASAL 22</span>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Jenis Pemungutan</label>
                            <select class="form-select" id="kb_jenisPPh22" onchange="kbUpdatePPh22()">
                                <option value="1.5">Pembelian oleh Bendaharawan (1.5%)</option>
                                <option value="0.25">Impor Barang Tertentu - Bebas (0.25%)</option>
                                <option value="2.5">Impor Barang Lain (2.5%)</option>
                                <option value="7.5">Impor Barang Mewah (7.5%)</option>
                                <option value="0.1">Penjualan BBM/Gas (0.1%)</option>
                                <option value="0.3">Penjualan Semen (0.3%)</option>
                                <option value="0.45">Penjualan Kertas (0.45%)</option>
                                <option value="0.3">Penjualan Baja (0.3%)</option>
                                <option value="0.25">Penjualan Otomotif (0.25%)</option>
                                <option value="0.3">Penjualan Farmasi (0.3%)</option>
                                <option value="custom">Custom Tarif</option>
                            </select>
                        </div>
                        <div class="form-group" id="kb_customTarifPPh22Group" style="display:none;">
                            <label class="form-label">Tarif Custom (%)</label>
                            <input type="number" class="form-input" id="kb_customTarifPPh22" placeholder="0" min="0" max="100" step="0.1">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Nilai Transaksi / DPP (Rp)</label>
                            <input type="text" class="form-input" id="kb_dppPPh22" placeholder="0" inputmode="decimal">
                        </div>
                        <button class="calc-btn" onclick="kbHitungPPh22()">Hitung PPh 22</button>
                        <div id="kb_resultPPh22" class="calc-result"></div>
                    </div>

                    <!-- PPN Biasa -->
                    <div class="kb-calc-card ppn">
                        <div class="calc-card-header">
                            <div class="calc-card-title">PPN</div>
                            <span class="calc-badge">11% / 12%</span>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Tarif PPN (%)</label>
                            <select class="form-select" id="kb_tarifPPN" onchange="kbUpdatePPN()">
                                <option value="12">12% - Tarif Umum (2025)</option>
                                <option value="11">11% - Tarif Lama</option>
                                <option value="1">1% - Pedagang Eceran</option>
                                <option value="2.2">2.2% - Tarif Efektif (PPh 22)</option>
                                <option value="custom">Custom Tarif</option>
                            </select>
                        </div>
                        <div class="form-group" id="kb_customTarifPPNGroup" style="display:none;">
                            <label class="form-label">Tarif Custom (%)</label>
                            <input type="number" class="form-input" id="kb_customTarifPPN" placeholder="0" min="0" max="100" step="0.1">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Jenis Input</label>
                            <select class="form-select" id="kb_inputTypePPN">
                                <option value="dpp">DPP (belum termasuk PPN)</option>
                                <option value="total">Total (sudah termasuk PPN)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label" id="kb_labelPPN">DPP (Rp)</label>
                            <input type="text" class="form-input" id="kb_dppPPN" placeholder="0" inputmode="decimal">
                        </div>
                        <button class="calc-btn" onclick="kbHitungPPN()">Hitung PPN</button>
                        <div id="kb_resultPPN" class="calc-result"></div>
                    </div>

                    <!-- PPh 15 Biasa -->
                    <div class="kb-calc-card" style="--card-color:#10b981;">
                        <div class="calc-card-header">
                            <div class="calc-card-title" style="color:var(--green);">PPh 15</div>
                            <span class="calc-badge" style="background:var(--green);">PASAL 15</span>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Jenis Wajib Pajak</label>
                            <select class="form-select" id="kb_jenisPPh15" onchange="kbUpdatePPh15()">
                                <option value="1.2">Pelayaran Dalam Negeri (1.2%)</option>
                                <option value="2.64">Pelayaran/Penerbangan LN (2.64%)</option>
                                <option value="1.8">Penerbangan Dalam Negeri (1.8%)</option>
                                <option value="custom">Custom Tarif</option>
                            </select>
                        </div>
                        <div class="form-group" id="kb_customTarifPPh15Group" style="display:none;">
                            <label class="form-label">Tarif Custom (%)</label>
                            <input type="number" class="form-input" id="kb_customTarifPPh15" placeholder="0" min="0" max="100" step="0.1">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Peredaran Bruto (Rp)</label>
                            <input type="text" class="form-input" id="kb_dppPPh15" placeholder="0" inputmode="decimal">
                        </div>
                        <button class="calc-btn" style="background:var(--green);" onclick="kbHitungPPh15()">Hitung PPh 15</button>
                        <div id="kb_resultPPh15" class="calc-result" style="border-left-color:var(--green);"></div>
                    </div>

                </div>
            </div>

            <!-- ‚ïê‚ïê MODE GROSS UP ‚ïê‚ïê -->
            <div id="calcModeGrossup" style="display:none;">
                <div class="mode-desc">
                    üí° <strong>Mode Gross Up</strong> ‚Äî Masukkan nilai nett (yang sudah dipotong pajak), hitung berapa DPP & pajak sebenarnya
                </div>

                <div class="calc-grid">
                    <!-- PPh 21 Gross Up -->
                    <div class="calc-card pph21">
                        <div class="calc-card-header">
                            <div class="calc-card-title">PPh 21</div>
                            <span class="calc-badge">PASAL 21</span>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Mode Perhitungan</label>
                            <select class="form-select" id="gu_modePPh21" onchange="guToggleModePPh21()">
                                <option value="ter">üìÖ TER Bulanan (PP 58/2023)</option>
                                <option value="tetap">üìã Tarif Tetap (Final/Tdk Final)</option>
                            </select>
                        </div>
                        <!-- TER group -->
                        <div id="gu_ter_group">
                            <div class="form-group">
                                <label class="form-label">Kategori PTKP</label>
                                <select class="form-select" id="gu_terKategori">
                                    <optgroup label="‚îÄ‚îÄ Kategori A ‚îÄ‚îÄ">
                                        <option value="A">TK/0 ‚Äî Lajang, tanpa tanggungan</option>
                                        <option value="A">TK/1 ‚Äî Lajang, 1 tanggungan</option>
                                        <option value="A">K/0 ‚Äî Kawin, 0 tanggungan</option>
                                    </optgroup>
                                    <optgroup label="‚îÄ‚îÄ Kategori B ‚îÄ‚îÄ">
                                        <option value="B">TK/2 ‚Äî Lajang, 2 tanggungan</option>
                                        <option value="B">TK/3 ‚Äî Lajang, 3 tanggungan</option>
                                        <option value="B">K/1 ‚Äî Kawin, 1 tanggungan</option>
                                        <option value="B">K/2 ‚Äî Kawin, 2 tanggungan</option>
                                    </optgroup>
                                    <optgroup label="‚îÄ‚îÄ Kategori C ‚îÄ‚îÄ">
                                        <option value="C">K/3 ‚Äî Kawin, 3 tanggungan</option>
                                    </optgroup>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Nett Diterima Sebulan (Rp)</label>
                                <input type="text" class="form-input" id="gu_ter_nett" placeholder="0" inputmode="decimal">
                            </div>
                        </div>
                        <!-- Tarif tetap group -->
                        <div id="gu_tetap_group" style="display:none;">
                            <div class="form-group">
                                <label class="form-label">Tarif Pajak (%)</label>
                                <select class="form-select" id="gu_tarifPPh21">
                                    <option value="0.5">0.5% ‚Äî Final</option>
                                    <option value="2.5">2.5% ‚Äî Tidak Final</option>
                                    <option value="5">5% ‚Äî Tidak Ber-NPWP</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Jumlah Nett (Rp)</label>
                                <input type="text" class="form-input" id="gu_nettPPh21" placeholder="0" inputmode="decimal">
                            </div>
                        </div>
                        <button class="calc-btn" onclick="guHitungPPh21()">Hitung Gross Up</button>
                        <div id="gu_resultPPh21" class="calc-result"></div>
                    </div>

                    <!-- PPh 23 Gross Up -->
                    <div class="calc-card pph23">
                        <div class="calc-card-header">
                            <div class="calc-card-title">PPh 23</div>
                            <span class="calc-badge">PASAL 23</span>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Jenis Penghasilan</label>
                            <select class="form-select" id="gu_jenisPPh23" onchange="guUpdateTarifPPh23()">
                                <option value="2">Dividen, Bunga, Royalti (2%)</option>
                                <option value="15">Jasa Teknik, Manajemen (2%)</option>
                                <option value="0.5">Sewa & Penghasilan Lain (2%)</option>
                                <option value="custom">Custom Tarif</option>
                            </select>
                        </div>
                        <div class="form-group" id="gu_customTarifPPh23Group" style="display:none;">
                            <label class="form-label">Tarif Custom (%)</label>
                            <input type="number" class="form-input" id="gu_customTarifPPh23" placeholder="0" min="0" max="100" step="0.1">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Jumlah Nett (Rp)</label>
                            <input type="text" class="form-input" id="gu_nettPPh23" placeholder="0" inputmode="decimal">
                        </div>
                        <button class="calc-btn" onclick="guHitungPPh23()">Hitung Gross Up</button>
                        <div id="gu_resultPPh23" class="calc-result"></div>
                    </div>

                    <!-- PPh 4(2) Gross Up -->
                    <div class="calc-card pph4">
                        <div class="calc-card-header">
                            <div class="calc-card-title">PPh 4(2)</div>
                            <span class="calc-badge">FINAL</span>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Jenis Penghasilan</label>
                            <select class="form-select" id="gu_jenisPPh4" onchange="guUpdateTarifPPh4()">
                                <option value="10">Sewa Tanah/Bangunan (10%)</option>
                                <option value="20">Bunga Deposito/Tabungan (20%)</option>
                                <optgroup label="A. Pelaksanaan Konstruksi">
                                    <option value="1.75">Kualifikasi Kecil/OP Bersertifikat (1.75%)</option>
                                    <option value="2.65">Menengah & Besar Bersertifikat (2.65%)</option>
                                    <option value="4">Tidak Punya Sertifikat SBU/SKK (4%)</option>
                                </optgroup>
                                <optgroup label="B. Perencanaan & Pengawasan">
                                    <option value="3.5">Punya Sertifikat (3.5%)</option>
                                    <option value="6">Tidak Punya Sertifikat (6%)</option>
                                </optgroup>
                                <optgroup label="C. Konstruksi Terintegrasi">
                                    <option value="2.65">Bersertifikat (2.65%)</option>
                                    <option value="4">Tidak Bersertifikat (4%)</option>
                                </optgroup>
                                <option value="2.5">Pengalihan Hak Tanah/Bangunan (2.5%)</option>
                                <option value="custom">Custom Tarif</option>
                            </select>
                        </div>
                        <div class="form-group" id="gu_customTarifPPh4Group" style="display:none;">
                            <label class="form-label">Tarif Custom (%)</label>
                            <input type="number" class="form-input" id="gu_customTarifPPh4" placeholder="0" min="0" max="100" step="0.1">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Jumlah Nett (Rp)</label>
                            <input type="text" class="form-input" id="gu_nettPPh4" placeholder="0" inputmode="decimal">
                        </div>
                        <button class="calc-btn" onclick="guHitungPPh4()">Hitung Gross Up</button>
                        <div id="gu_resultPPh4" class="calc-result"></div>
                    </div>

                    <!-- PPN Gross Up -->
                    <div class="calc-card ppn">
                        <div class="calc-card-header">
                            <div class="calc-card-title">PPN</div>
                            <span class="calc-badge">PAJAK</span>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Tarif PPN (%)</label>
                            <select class="form-select" id="gu_tarifPPN" onchange="guUpdateTarifPPN()">
                                <option value="12">12% - Tarif Umum (2025)</option>
                                <option value="1">1% - Pedagang Eceran</option>
                                <option value="2.2">2.2% - Tarif Efektif (PPh 22)</option>
                                <option value="custom">Custom Tarif</option>
                            </select>
                        </div>
                        <div class="form-group" id="gu_customTarifPPNGroup" style="display:none;">
                            <label class="form-label">Tarif Custom (%)</label>
                            <input type="number" class="form-input" id="gu_customTarifPPN" placeholder="0" min="0" max="100" step="0.1">
                        </div>
                        <div class="form-group">
                            <label class="form-label">DPP (Rp)</label>
                            <input type="text" class="form-input" id="gu_nettPPN" placeholder="0" inputmode="decimal">
                        </div>
                        <button class="calc-btn" onclick="guHitungPPN()">Hitung Gross Up</button>
                        <div id="gu_resultPPN" class="calc-result"></div>
                    </div>
                </div>
            </div>

            <!-- ‚ïê‚ïê MODE PPH 21 PROGRESIF ‚ïê‚ïê -->
            <div id="calcModeProgresif" style="display:none;">
                <div class="mode-desc">
                    üí° <strong>Mode PPh 21 Progresif</strong> ‚Äî Masukkan PKP (Penghasilan Kena Pajak) setahun, hitung PPh 21 dengan tarif berlapis Pasal 17 UU HPP No. 7 Tahun 2021
                </div>

                <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:20px;">
                    <div class="form-group" style="margin-bottom:0;">
                        <label class="form-label">Penghasilan Kena Pajak (PKP) Setahun</label>
                        <input type="text" class="form-input" id="prog_pkp" placeholder="Contoh: 500.000.000" inputmode="decimal" oninput="progFormatInput(this);progHitung()">
                    </div>
                    <div class="form-group" style="margin-bottom:0;">
                        <label class="form-label">Status NPWP</label>
                        <select class="form-select" id="prog_npwp" onchange="progHitung()">
                            <option value="1">‚úÖ Ber-NPWP ‚Äî tarif normal</option>
                            <option value="1.2">‚ùå Tidak Ber-NPWP ‚Äî tarif +20%</option>
                        </select>
                    </div>
                </div>

                <!-- Summary Cards -->
                <div id="prog_summaryCards" style="display:none;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:12px;margin-bottom:20px;">
                    <div style="background:rgba(6,182,212,0.08);border:1px solid rgba(6,182,212,0.25);border-radius:12px;padding:16px;text-align:center;">
                        <div style="font-size:10px;font-family:'IBM Plex Mono',monospace;color:var(--text-muted);letter-spacing:0.06em;text-transform:uppercase;margin-bottom:6px;">PKP Setahun</div>
                        <div id="prog_r_pkp" style="font-family:'Syne',sans-serif;font-size:16px;font-weight:700;color:var(--cyan);">‚Äì</div>
                    </div>
                    <div style="background:rgba(16,185,129,0.08);border:1px solid rgba(16,185,129,0.25);border-radius:12px;padding:16px;text-align:center;">
                        <div style="font-size:10px;font-family:'IBM Plex Mono',monospace;color:var(--text-muted);letter-spacing:0.06em;text-transform:uppercase;margin-bottom:6px;">PPh Terutang</div>
                        <div id="prog_r_pph" style="font-family:'Syne',sans-serif;font-size:16px;font-weight:700;color:var(--green);">‚Äì</div>
                    </div>
                    <div style="background:rgba(139,92,246,0.08);border:1px solid rgba(139,92,246,0.25);border-radius:12px;padding:16px;text-align:center;">
                        <div style="font-size:10px;font-family:'IBM Plex Mono',monospace;color:var(--text-muted);letter-spacing:0.06em;text-transform:uppercase;margin-bottom:6px;">Tarif Efektif</div>
                        <div id="prog_r_efektif" style="font-family:'Syne',sans-serif;font-size:16px;font-weight:700;color:var(--purple);">‚Äì</div>
                    </div>
                    <div style="background:rgba(245,158,11,0.08);border:1px solid rgba(245,158,11,0.25);border-radius:12px;padding:16px;text-align:center;">
                        <div style="font-size:10px;font-family:'IBM Plex Mono',monospace;color:var(--text-muted);letter-spacing:0.06em;text-transform:uppercase;margin-bottom:6px;">PPh / Bulan</div>
                        <div id="prog_r_bulanan" style="font-family:'Syne',sans-serif;font-size:16px;font-weight:700;color:var(--yellow);">‚Äì</div>
                    </div>
                </div>

                <!-- Breakdown Table -->
                <div id="prog_breakdownWrap" style="display:none;background:var(--bg);border:1px solid var(--border);border-radius:12px;overflow:hidden;margin-bottom:14px;">
                    <div style="padding:12px 16px;border-bottom:1px solid var(--border);font-family:'IBM Plex Mono',monospace;font-size:11px;letter-spacing:0.08em;text-transform:uppercase;color:var(--text-muted);">
                        üìä Rincian Lapisan Pajak ‚Äî Pasal 17 UU HPP
                    </div>
                    <div style="overflow-x:auto;">
                        <table style="width:100%;border-collapse:collapse;font-size:13px;">
                            <thead>
                                <tr style="background:linear-gradient(135deg,#1e3a5f,#263548);">
                                    <th style="padding:10px 14px;text-align:left;font-family:'IBM Plex Mono',monospace;font-size:10px;letter-spacing:0.04em;text-transform:uppercase;color:var(--accent2);white-space:nowrap;">Lapisan</th>
                                    <th style="padding:10px 14px;text-align:center;font-family:'IBM Plex Mono',monospace;font-size:10px;letter-spacing:0.04em;text-transform:uppercase;color:var(--accent2);">Tarif</th>
                                    <th style="padding:10px 14px;text-align:right;font-family:'IBM Plex Mono',monospace;font-size:10px;letter-spacing:0.04em;text-transform:uppercase;color:var(--accent2);white-space:nowrap;">PKP di Lapisan</th>
                                    <th style="padding:10px 14px;text-align:right;font-family:'IBM Plex Mono',monospace;font-size:10px;letter-spacing:0.04em;text-transform:uppercase;color:var(--accent2);">Pajak</th>
                                    <th style="padding:10px 14px;text-align:right;font-family:'IBM Plex Mono',monospace;font-size:10px;letter-spacing:0.04em;text-transform:uppercase;color:var(--accent2);white-space:nowrap;">Akumulasi</th>
                                </tr>
                            </thead>
                            <tbody id="prog_tbody"></tbody>
                            <tfoot id="prog_tfoot"></tfoot>
                        </table>
                    </div>
                </div>

                <!-- Non-NPWP warning -->
                <div id="prog_nonNpwpNote" style="display:none;padding:12px 16px;background:rgba(239,68,68,0.08);border:1px solid rgba(239,68,68,0.2);border-radius:10px;font-size:12px;color:#f87171;font-family:'IBM Plex Mono',monospace;margin-bottom:12px;">
                    ‚ö†Ô∏è Tidak Ber-NPWP: PPh ditambahkan 20% dari tarif normal (Pasal 21 ayat 5a UU PPh)
                </div>

                <!-- Info note -->
                <div style="padding:12px 16px;background:rgba(59,130,246,0.06);border:1px solid rgba(59,130,246,0.15);border-radius:10px;font-size:12px;color:var(--text-dim);margin-bottom:16px;">
                    üí° <strong>Catatan:</strong> Kalkulator ini menggunakan tarif Pasal 17 untuk perhitungan PPh 21 tahunan (SPT/masa Desember). Pemotongan bulanan Jan‚ÄìNov 2024+ menggunakan Tarif Efektif Rata-rata (TER) sesuai PP 58/2023.
                </div>

                <!-- Tarif Reference Table -->
                <div style="background:var(--bg);border:1px solid var(--border);border-radius:12px;overflow:hidden;">
                    <div style="padding:12px 16px;border-bottom:1px solid var(--border);font-family:'IBM Plex Mono',monospace;font-size:11px;letter-spacing:0.08em;text-transform:uppercase;color:var(--text-muted);">
                        üìã Referensi Tarif Pasal 17 UU HPP No. 7 Tahun 2021
                    </div>
                    <table style="width:100%;border-collapse:collapse;font-size:13px;">
                        <thead>
                            <tr style="background:linear-gradient(135deg,#1e3a5f,#263548);">
                                <th style="padding:9px 14px;text-align:left;font-family:'IBM Plex Mono',monospace;font-size:10px;color:var(--accent2);text-transform:uppercase;letter-spacing:0.04em;">Lapisan PKP</th>
                                <th style="padding:9px 14px;text-align:center;font-family:'IBM Plex Mono',monospace;font-size:10px;color:var(--accent2);text-transform:uppercase;letter-spacing:0.04em;">Tarif</th>
                                <th style="padding:9px 14px;text-align:right;font-family:'IBM Plex Mono',monospace;font-size:10px;color:var(--accent2);text-transform:uppercase;letter-spacing:0.04em;white-space:nowrap;">Pajak Maks Lapisan</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr style="border-bottom:1px solid var(--border);">
                                <td style="padding:9px 14px;color:var(--text);">s.d. Rp 60.000.000</td>
                                <td style="padding:9px 14px;text-align:center;font-weight:700;color:var(--cyan);font-family:'IBM Plex Mono',monospace;">5%</td>
                                <td style="padding:9px 14px;text-align:right;color:var(--text-dim);font-family:'IBM Plex Mono',monospace;">Rp 3.000.000</td>
                            </tr>
                            <tr style="border-bottom:1px solid var(--border);background:rgba(255,255,255,0.02);">
                                <td style="padding:9px 14px;color:var(--text);">&gt; Rp 60 jt s.d. Rp 250 jt</td>
                                <td style="padding:9px 14px;text-align:center;font-weight:700;color:var(--green);font-family:'IBM Plex Mono',monospace;">15%</td>
                                <td style="padding:9px 14px;text-align:right;color:var(--text-dim);font-family:'IBM Plex Mono',monospace;">Rp 28.500.000</td>
                            </tr>
                            <tr style="border-bottom:1px solid var(--border);">
                                <td style="padding:9px 14px;color:var(--text);">&gt; Rp 250 jt s.d. Rp 500 jt</td>
                                <td style="padding:9px 14px;text-align:center;font-weight:700;color:var(--yellow);font-family:'IBM Plex Mono',monospace;">25%</td>
                                <td style="padding:9px 14px;text-align:right;color:var(--text-dim);font-family:'IBM Plex Mono',monospace;">Rp 62.500.000</td>
                            </tr>
                            <tr style="border-bottom:1px solid var(--border);background:rgba(255,255,255,0.02);">
                                <td style="padding:9px 14px;color:var(--text);">&gt; Rp 500 jt s.d. Rp 5.000.000.000</td>
                                <td style="padding:9px 14px;text-align:center;font-weight:700;color:var(--orange);font-family:'IBM Plex Mono',monospace;">30%</td>
                                <td style="padding:9px 14px;text-align:right;color:var(--text-dim);font-family:'IBM Plex Mono',monospace;">Rp 1.335.000.000</td>
                            </tr>
                            <tr>
                                <td style="padding:9px 14px;color:var(--text);">&gt; Rp 5.000.000.000</td>
                                <td style="padding:9px 14px;text-align:center;font-weight:700;color:var(--pink);font-family:'IBM Plex Mono',monospace;">35%</td>
                                <td style="padding:9px 14px;text-align:right;color:var(--text-dim);font-family:'IBM Plex Mono',monospace;">Tidak terbatas</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- ‚ïê‚ïê MODE IMPORT EXCEL ‚ïê‚ïê -->
            <div id="calcModeImport" style="display:none;">
                <div class="mode-desc">
                    üí° <strong>Mode Import Excel</strong> ‚Äî Upload file Excel berisi data pajak, hitung otomatis, dan download hasilnya kembali ke Excel. Mendukung PPh 21 (TER &amp; Tarif Tetap), PPh 23, PPh 4(2), PPh 22, PPN, PPh 15, dan PPh 21 Progresif.
                </div>

                <!-- Template Download -->
                <div style="background:var(--bg);border:1px solid var(--border);border-radius:14px;padding:20px;margin-bottom:16px;">
                    <div style="font-family:'IBM Plex Mono',monospace;font-size:11px;letter-spacing:0.08em;text-transform:uppercase;color:var(--text-muted);margin-bottom:14px;">üìã Step 1 ‚Äî Download Template</div>
                    <p style="font-size:13px;color:var(--text-dim);margin-bottom:14px;">Pilih jenis perhitungan, download template Excel, isi data, lalu upload kembali.</p>
                    <div class="form-group" style="margin-bottom:14px;">
                        <label class="form-label">Jenis Perhitungan</label>
                        <select class="form-select" id="imp_jenis" onchange="impUpdateInfo()">
                            <option value="pph21_ter">PPh 21 ‚Äî TER Bulanan (PP 58/2023)</option>
                            <option value="pph21_tetap">PPh 21 ‚Äî Tarif Tetap (Final/Tdk Final)</option>
                            <option value="pph21_progresif">PPh 21 ‚Äî Progresif Tahunan (Pasal 17)</option>
                            <option value="pph23">PPh 23</option>
                            <option value="pph4">PPh 4(2)</option>
                            <option value="pph22">PPh 22</option>
                            <option value="ppn">PPN</option>
                            <option value="pph15">PPh 15</option>
                        </select>
                    </div>
                    <div id="imp_info" style="font-size:12px;color:var(--text-dim);background:rgba(59,130,246,0.06);border:1px solid rgba(59,130,246,0.15);border-radius:8px;padding:10px 14px;margin-bottom:14px;font-family:'IBM Plex Mono',monospace;line-height:1.7;"></div>
                    <button class="btn btn-yellow" onclick="impDownloadTemplate()">üì• Download Template Excel</button>
                </div>

                <!-- Upload -->
                <div style="background:var(--bg);border:1px solid var(--border);border-radius:14px;padding:20px;margin-bottom:16px;">
                    <div style="font-family:'IBM Plex Mono',monospace;font-size:11px;letter-spacing:0.08em;text-transform:uppercase;color:var(--text-muted);margin-bottom:14px;">üì§ Step 2 ‚Äî Upload & Hitung</div>
                    <div class="upload-area" id="impUploadArea" style="margin-bottom:14px;" onclick="document.getElementById('impFileInput').click()">
                        <span class="upload-icon">üìä</span>
                        <div class="upload-title">Klik atau Drag & Drop File Excel</div>
                        <div class="upload-sub">Support: .xlsx, .xls ‚Äî sesuai template yang didownload</div>
                        <input type="file" id="impFileInput" accept=".xlsx,.xls" style="display:none;" onchange="impHandleFile(this)">
                    </div>
                    <div id="impFileInfo" style="display:none;font-size:12px;color:var(--green);font-family:'IBM Plex Mono',monospace;margin-bottom:10px;"></div>
                    <div id="impErrorBox" style="display:none;font-size:12px;color:#f87171;font-family:'IBM Plex Mono',monospace;background:rgba(239,68,68,0.08);border:1px solid rgba(239,68,68,0.2);border-radius:8px;padding:10px 14px;margin-bottom:10px;"></div>
                </div>

                <!-- Preview & Result -->
                <div id="impResultSection" style="display:none;background:var(--bg);border:1px solid var(--border);border-radius:14px;padding:20px;">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px;flex-wrap:wrap;gap:10px;">
                        <div style="font-family:'IBM Plex Mono',monospace;font-size:11px;letter-spacing:0.08em;text-transform:uppercase;color:var(--text-muted);">‚úÖ Hasil Perhitungan</div>
                        <div style="display:flex;gap:8px;flex-wrap:wrap;">
                            <div id="impSummaryBadge" style="font-size:12px;font-family:'IBM Plex Mono',monospace;color:var(--green);background:rgba(16,185,129,0.1);border:1px solid rgba(16,185,129,0.25);border-radius:6px;padding:4px 12px;"></div>
                            <button class="btn btn-green" onclick="impDownloadResult()" style="padding:8px 18px;font-size:13px;">üì• Download Hasil Excel</button>
                        </div>
                    </div>
                    <div style="overflow-x:auto;border-radius:10px;border:1px solid var(--border);">
                        <table id="impPreviewTable" style="width:100%;border-collapse:collapse;font-size:12px;background:var(--bg);">
                            <thead id="impPreviewHead"></thead>
                            <tbody id="impPreviewBody"></tbody>
                        </table>
                    </div>
                    <div style="font-size:11px;color:var(--text-muted);font-family:'IBM Plex Mono',monospace;margin-top:8px;">* Preview menampilkan maks. 50 baris pertama</div>
                </div>
            </div>

            <!-- Info Section -->
            <div class="tool-card" style="margin-top:16px;background:var(--bg);">
                <div class="section-label" style="margin-bottom:14px;">Informasi Tarif Pajak</div>
                <div class="info-grid">
                    <div class="info-card pph21">
                        <h3>PPh Pasal 21</h3>
                        <p>Pajak atas penghasilan berupa gaji, upah, honorarium, tunjangan, dan pembayaran lain yang diterima oleh pegawai atau bukan pegawai.</p>
                    </div>
                    <div class="info-card pph23">
                        <h3>PPh Pasal 23</h3>
                        <p>Pajak atas penghasilan berupa dividen, bunga, royalti, hadiah, serta imbalan jasa teknik, manajemen, konsultan, dan jasa lainnya.</p>
                    </div>
                    <div class="info-card pph4">
                        <h3>PPh Pasal 4 Ayat 2</h3>
                        <p>Pajak penghasilan bersifat final atas jenis penghasilan tertentu: bunga deposito, sewa tanah/bangunan, jasa konstruksi, dan pengalihan hak.</p>
                    </div>
                    <div class="info-card ppn">
                        <h3>PPN (Pajak Pertambahan Nilai)</h3>
                        <p>Pajak atas konsumsi BKP dan/atau JKP di dalam daerah pabean. Tarif umum 12% berlaku mulai tahun 2025.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ TAB 3: PDF PPh21 ‚Üí Excel ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
    <div id="tab-pph21" class="tool-panel">
        <div class="tool-card">
            <div class="tool-card-header">
                <div class="tool-card-icon" style="background:linear-gradient(135deg,rgba(6,182,212,0.15),rgba(59,130,246,0.1));border:1px solid rgba(6,182,212,0.3)">üìä</div>
                <div>
                    <div class="tool-card-title">PDF PPh Dipotong ‚Üí Excel</div>
                    <div class="tool-card-desc">Konversi multiple PDF Bukti Pemotongan PPh 21 ke format Excel</div>
                </div>
            </div>

            <div class="upload-area" id="pph21UploadArea">
                <span class="upload-icon">üìÑ</span>
                <div class="upload-title">Klik atau seret file PDF ke sini</div>
                <div class="upload-sub">Mendukung multiple files PDF PPh Dipotong</div>
                <input type="file" id="pph21FileInput" accept=".pdf" multiple>
            </div>

            <div class="file-list-wrap" id="pph21FileList">
                <div class="file-list-title">üìã FILE DIPILIH</div>
                <div id="pph21FileItems"></div>
                <div style="margin-top:8px;">
                    <button class="btn btn-red" id="pph21ClearBtn" style="font-size:12px;padding:8px 14px;">üóëÔ∏è Hapus Semua</button>
                </div>
            </div>

            <div class="options-panel">
                <div class="options-title">‚öôÔ∏è Opsi Konversi</div>
                <div class="option-item">
                    <input type="checkbox" id="pph21_taxDocMode" checked>
                    <label for="pph21_taxDocMode">üßæ Mode Dokumen Pajak (PPh diPotong)</label>
                </div>
                <div class="option-item">
                    <input type="checkbox" id="pph21_detectTables" checked>
                    <label for="pph21_detectTables">Deteksi tabel otomatis</label>
                </div>
                <div class="option-item">
                    <input type="checkbox" id="pph21_mergePages" checked>
                    <label for="pph21_mergePages">Gabungkan semua halaman dalam satu sheet</label>
                </div>
                <div class="option-item">
                    <input type="checkbox" id="pph21_smartCols" checked>
                    <label for="pph21_smartCols">Smart column detection</label>
                </div>
                <div class="option-item">
                    <input type="checkbox" id="pph21_separateFiles">
                    <label for="pph21_separateFiles">Pisahkan setiap file dalam sheet terpisah</label>
                </div>
            </div>

            <div class="btn-row">
                <button class="btn btn-primary" id="pph21ConvertBtn" style="display:none;" onclick="pph21Convert()">üîÑ Konversi ke Excel</button>
            </div>

            <div class="progress-wrap" id="pph21Progress">
                <div class="progress-bar"><div class="progress-fill" id="pph21ProgressFill"></div></div>
                <div class="progress-text" id="pph21ProgressText">Memproses...</div>
            </div>

            <div class="result-area" id="pph21ResultArea">
                <div class="result-area-title">‚úÖ Konversi Berhasil!</div>
                <div id="pph21PreviewArea"></div>
                <div class="btn-row" style="margin-top:12px;">
                    <button class="btn btn-green" onclick="pph21Download()">üì• Download Excel</button>
                </div>
            </div>

            <div class="error-box" id="pph21ErrorBox"></div>
        </div>
    </div>

    <!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ TAB 4: PDF BPPU ‚Üí Excel ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
    <div id="tab-bppu" class="tool-panel">
        <div class="tool-card">
            <div class="tool-card-header">
                <div class="tool-card-icon" style="background:linear-gradient(135deg,rgba(139,92,246,0.15),rgba(236,72,153,0.1));border:1px solid rgba(139,92,246,0.3)">üìë</div>
                <div>
                    <div class="tool-card-title">PDF BPPU ‚Üí Excel</div>
                    <div class="tool-card-desc">Konversi multiple PDF Bukti Pemotongan/Pemungutan ke format Excel</div>
                </div>
            </div>

            <div class="upload-area" id="bppuUploadArea">
                <span class="upload-icon">üìÑ</span>
                <div class="upload-title">Klik atau seret file PDF ke sini</div>
                <div class="upload-sub">Mendukung multiple files PDF BPPU</div>
                <input type="file" id="bppuFileInput" accept=".pdf" multiple>
            </div>

            <div class="file-list-wrap" id="bppuFileList">
                <div class="file-list-title">üìã FILE DIPILIH</div>
                <div id="bppuFileItems"></div>
                <div style="margin-top:8px;">
                    <button class="btn btn-red" id="bppuClearBtn" style="font-size:12px;padding:8px 14px;">üóëÔ∏è Hapus Semua</button>
                </div>
            </div>

            <div class="options-panel">
                <div class="options-title">‚öôÔ∏è Opsi Konversi</div>
                <div class="option-item">
                    <input type="checkbox" id="bppu_taxDocMode" checked>
                    <label for="bppu_taxDocMode">üßæ Mode Dokumen Pajak (PPh diPotong)</label>
                </div>
                <div class="option-item">
                    <input type="checkbox" id="bppu_detectTables" checked>
                    <label for="bppu_detectTables">Deteksi tabel otomatis</label>
                </div>
                <div class="option-item">
                    <input type="checkbox" id="bppu_mergePages" checked>
                    <label for="bppu_mergePages">Gabungkan semua halaman dalam satu sheet</label>
                </div>
                <div class="option-item">
                    <input type="checkbox" id="bppu_smartCols" checked>
                    <label for="bppu_smartCols">Smart column detection</label>
                </div>
                <div class="option-item">
                    <input type="checkbox" id="bppu_separateFiles">
                    <label for="bppu_separateFiles">Pisahkan setiap file dalam sheet terpisah</label>
                </div>
            </div>

            <div class="btn-row">
                <button class="btn btn-primary" id="bppuConvertBtn" style="display:none;" onclick="bppuConvert()">üîÑ Konversi ke Excel</button>
            </div>

            <div class="progress-wrap" id="bppuProgress">
                <div class="progress-bar"><div class="progress-fill" id="bppuProgressFill"></div></div>
                <div class="progress-text" id="bppuProgressText">Memproses...</div>
            </div>

            <div class="result-area" id="bppuResultArea">
                <div class="result-area-title">‚úÖ Konversi Berhasil!</div>
                <div id="bppuPreviewArea"></div>
                <div class="btn-row" style="margin-top:12px;">
                    <button class="btn btn-green" onclick="bppuDownload()">üì• Download Excel</button>
                </div>
            </div>

            <div class="error-box" id="bppuErrorBox"></div>
        </div>
    </div>

    <!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ TAB 5: Faktur Pajak Coretax ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
    <div id="tab-faktur" class="tool-panel">
        <div class="tool-card">
            <div class="tool-card-header">
                <div class="tool-card-icon" style="background:linear-gradient(135deg,rgba(245,158,11,0.15),rgba(249,115,22,0.1));border:1px solid rgba(245,158,11,0.3)">üßæ</div>
                <div>
                    <div class="tool-card-title">Ekstrak Faktur Pajak PDF Coretax ‚Üí Excel</div>
                    <div class="tool-card-desc">Upload file PDF faktur pajak untuk mengekstrak data ke format Excel</div>
                </div>
            </div>

            <div class="upload-area" id="fpUploadBox">
                <span class="upload-icon">üì§</span>
                <div class="upload-title">Klik atau Drop PDF di sini</div>
                <div class="upload-sub">Mendukung multiple file PDF faktur pajak Indonesia</div>
                <input type="file" id="fpFileInput" accept=".pdf" multiple>
            </div>

            <div id="fpFileInfo" style="margin-top:10px;"></div>

            <div class="btn-row" style="margin-top:14px;">
                <button class="btn btn-primary" id="fpProcessBtn" disabled onclick="fpProcess()">‚ö° Proses PDF</button>
                <button class="btn btn-green" id="fpDownloadBtn" style="display:none;" onclick="fpDownload()">üì• Download Excel</button>
                <button class="btn btn-red" id="fpClearBtn" style="display:none;" onclick="fpClear()">üóëÔ∏è Clear</button>
            </div>

            <div id="fpStatus" style="margin-top:12px;font-size:13px;color:var(--text-dim);font-family:'IBM Plex Mono',monospace;min-height:20px;">Belum ada file yang dipilih</div>

            <div id="fpResultSection" style="display:none;margin-top:16px;">
                <div class="section-label" style="margin-bottom:10px;">Hasil Ekstraksi</div>
                <div class="fp-table-wrap">
                    <table class="fp-table">
                        <thead>
                            <tr>
                                <th>No. Faktur Pajak</th>
                                <th>Nama Penjual</th>
                                <th>NPWP Penjual</th>
                                <th>Nama Barang</th>
                                <th>Harga</th>
                                <th>Qty</th>
                                <th>Discount</th>
                                <th>Total</th>
                                <th>PPN</th>
                                <th>Nama Pembeli</th>
                                <th>NPWP Pembeli</th>
                                <th>Referensi</th>
                            </tr>
                        </thead>
                        <tbody id="fpResultBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

</div>

<footer class="footer">
    ¬© 2025 PajakTools ‚Äî Suite Lengkap Alat Pajak Indonesia ¬∑ by Irvan_Signora
</footer>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  TAB NAVIGATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function switchTab(id) {
    document.querySelectorAll('.tab-btn').forEach((b, i) => {
        const tabs = ['xml','grossup','pph21','bppu','faktur'];
        b.classList.toggle('active', tabs[i] === id);
    });
    document.querySelectorAll('.tool-panel').forEach(p => p.classList.remove('active'));
    document.getElementById('tab-' + id).classList.add('active');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  TAB 1: EXCEL ‚Üí XML
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let xmlSelectedTIN = null, xmlSelectedIDTKU = null, xmlSelectedCompany = null;
let xmlExcelData = null, xmlContent = '';

function xmlSelectCompany(el) {
    document.querySelectorAll('.company-card').forEach(c => c.classList.remove('active'));
    el.classList.add('active');
    xmlSelectedCompany = el.dataset.company;

    const customWrap = document.getElementById('xmlCustomInputWrap');

    if (xmlSelectedCompany === 'CUSTOM') {
        // Show custom input, don't set TIN yet until valid
        customWrap.style.display = 'block';
        xmlSelectedTIN   = null;
        xmlSelectedIDTKU = null;
        xmlUpdateCustom(); // validate current input state
        return;
    } else {
        customWrap.style.display = 'none';
    }

    xmlSelectedTIN   = el.dataset.tin;
    xmlSelectedIDTKU = el.dataset.idtku;

    const badge = document.getElementById('xmlActiveBadge');
    badge.classList.add('show');
    document.getElementById('xmlActiveBadgeText').textContent = `Perusahaan aktif: ${xmlSelectedCompany} ¬∑ NPWP: ${xmlSelectedTIN}`;
    if (xmlExcelData) document.getElementById('xmlConvertBtn').disabled = false;
}

function xmlUpdateCustom() {
    const name     = document.getElementById('xmlCustomName').value.trim();
    const npwpRaw  = document.getElementById('xmlCustomNpwp').value.replace(/\D/g, '');
    const valEl    = document.getElementById('xmlCustomValidation');
    const cardNpwp = document.getElementById('xmlCustomCardNpwp');

    // Enforce digits only in input
    document.getElementById('xmlCustomNpwp').value = npwpRaw;

    if (npwpRaw.length === 0) {
        valEl.textContent = '';
        cardNpwp.textContent = 'Klik untuk isi NPWP';
        xmlSelectedTIN = null; xmlSelectedIDTKU = null;
        document.getElementById('xmlConvertBtn').disabled = true;
        document.getElementById('xmlActiveBadge').classList.remove('show');
        return;
    }

    if (npwpRaw.length !== 16) {
        valEl.style.color = '#f87171';
        valEl.textContent = `‚ùå NPWP harus 16 digit ‚Äî saat ini ${npwpRaw.length} digit`;
        xmlSelectedTIN = null; xmlSelectedIDTKU = null;
        document.getElementById('xmlConvertBtn').disabled = true;
        document.getElementById('xmlActiveBadge').classList.remove('show');
        cardNpwp.textContent = npwpRaw || 'Klik untuk isi NPWP';
        return;
    }

    // Valid ‚Äî update globals
    xmlSelectedTIN   = npwpRaw;
    xmlSelectedIDTKU = npwpRaw + '000000';   // IDTKU = TIN + 6 digit suffix 000000
    const displayName = name || 'Custom';

    // Update card display
    cardNpwp.textContent = npwpRaw;
    document.getElementById('xmlCustomCard').dataset.tin   = npwpRaw;
    document.getElementById('xmlCustomCard').dataset.idtku = xmlSelectedIDTKU;

    valEl.style.color = 'var(--green)';
    valEl.textContent = `‚úÖ NPWP valid ¬∑ IDTKU: ${xmlSelectedIDTKU}`;

    const badge = document.getElementById('xmlActiveBadge');
    badge.classList.add('show');
    document.getElementById('xmlActiveBadgeText').textContent = `Perusahaan aktif: ${displayName} ¬∑ NPWP: ${npwpRaw}`;

    if (xmlExcelData) document.getElementById('xmlConvertBtn').disabled = false;
}

(function() {
    const ua = document.getElementById('xmlUploadArea');
    const fi = document.getElementById('xmlFileInput');
    ua.addEventListener('click', () => fi.click());
    ua.addEventListener('dragover', e => { e.preventDefault(); ua.classList.add('dragover'); });
    ua.addEventListener('dragleave', () => ua.classList.remove('dragover'));
    ua.addEventListener('drop', e => { e.preventDefault(); ua.classList.remove('dragover'); xmlHandleFile(e.dataTransfer.files[0]); });
    fi.addEventListener('change', e => xmlHandleFile(e.target.files[0]));
    document.getElementById('xmlConvertBtn').addEventListener('click', xmlConvert);
    document.getElementById('xmlCopyBtn').addEventListener('click', xmlCopy);
    document.getElementById('xmlDownloadBtn').addEventListener('click', xmlDownloadFile);
})();

function xmlHandleFile(file) {
    if (!file) return;
    const reader = new FileReader();
    reader.onload = e => {
        const wb = XLSX.read(new Uint8Array(e.target.result), { type: 'array' });
        xmlExcelData = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
        const ua = document.getElementById('xmlUploadArea');
        ua.innerHTML = `<span class="upload-icon" style="color:var(--green);">‚úÖ</span><div class="upload-title" style="color:var(--green);">${file.name}</div><div class="upload-sub">${xmlExcelData.length} baris data terdeteksi</div><input type="file" id="xmlFileInput" accept=".xlsx,.xls" style="display:none">`;
        ua.querySelector('#xmlFileInput').addEventListener('change', ev => xmlHandleFile(ev.target.files[0]));
        ua.onclick = () => ua.querySelector('#xmlFileInput').click();
        ua.classList.add('success');
        if (xmlSelectedTIN) document.getElementById('xmlConvertBtn').disabled = false;
    };
    reader.readAsArrayBuffer(file);
}

function xmlDownloadTemplate() {
    const data = [
        { TaxInvoiceDate:'2025-02-02', RefDesc:'Referensi 001', BuyerDocument:'TIN', BuyerDocumentNumber:'1091031210912281', BuyerName:'PT CONTOH PEMBELI', BuyerAdress:'Jl. Contoh No. 123', BuyerEmail:'buyer@example.com', Name:'Barang Contoh', Price:15000, Qty:200, TotalDiscount:100000, TaxBase:2900000, Type:Jasa },
        { TaxInvoiceDate:'2025-02-03', RefDesc:'Referensi 002', BuyerDocument:'National ID', BuyerDocumentNumber:'3201234567890123', BuyerName:'John Doe', BuyerAdress:'Jl. Merdeka No. 45', BuyerEmail:'john@example.com', Name:'Produk Sample', Price:25000, Qty:100, TotalDiscount:50000, TaxBase:2450000, Type:Barang }
    ];
    const ws = XLSX.utils.json_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Template');
    XLSX.writeFile(wb, 'Template_Tax_Invoice.xlsx');
}

function xmlEscape(v) {
    if (!v) return '';
    return String(v).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&apos;');
}

function xmlFormatDate(v) {
    if (!v) return '';
    if (isNaN(v)) {
        const d = new Date(v);
        if (!isNaN(d)) return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
        return '';
    }
    const epoch = new Date(Date.UTC(1899,11,30));
    const r = new Date(epoch.getTime() + v * 86400000);
    return `${r.getUTCFullYear()}-${String(r.getUTCMonth()+1).padStart(2,'0')}-${String(r.getUTCDate()).padStart(2,'0')}`;
}

function xmlNum(v) {
    if (v === undefined || v === null) return 0;
    if (typeof v === 'number') return v;
    let s = String(v).trim();
    if (/^\d{1,3}(\.\d{3})+,\d+$/.test(s)) s = s.replace(/\./g,'').replace(',','.');
    else if (/^\d{1,3}(,\d{3})+\.\d+$/.test(s)) s = s.replace(/,/g,'');
    else s = s.replace(/[^0-9.\-]/g,'');
    const n = Number(s);
    return isNaN(n) ? 0 : n;
}

function xmlConvert() {
    if (!xmlExcelData || !xmlExcelData.length) return;
    if (!xmlSelectedTIN) { alert('‚ö†Ô∏è Silakan pilih perusahaan terlebih dahulu!'); return; }
    const fixed = { TIN: xmlSelectedTIN, TaxInvoiceOpt:'Normal', TrxCode:'04', SellerIDTKU: xmlSelectedIDTKU, Unit:'UM.0021', STLGRate:'0', STLG:'0', Opt:'A', Code:'000000', BuyerCountry:'IDN', VATRate:'12' };
    const grouped = {};
    xmlExcelData.forEach(row => { const ref = row.RefDesc || 'NO-REF'; if (!grouped[ref]) grouped[ref] = []; grouped[ref].push(row); });
    let xml = `<?xml version="1.0" encoding="utf-8" ?>\n<TaxInvoiceBulk xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="TaxInvoice.xsd">\n\t<TIN>${fixed.TIN}</TIN>\n\t<ListOfTaxInvoice>\n`;
    Object.keys(grouped).forEach(refDesc => {
        const items = grouped[refDesc], first = items[0];
        let buyerTin = '', buyerDocNum = '';
        if (first.BuyerDocument === 'National ID') { buyerTin = '0000000000000000'; buyerDocNum = first.BuyerDocumentNumber || ''; }
        else if (first.BuyerDocument === 'TIN') { buyerTin = first.BuyerDocumentNumber || ''; buyerDocNum = ''; }
        let buyerIDTKU = first.BuyerDocument === 'National ID' ? '000000' : `${buyerTin}000000`.padEnd(22,'0');
        xml += `\t<TaxInvoice>\n\t\t<TaxInvoiceDate>${xmlFormatDate(first.TaxInvoiceDate)}</TaxInvoiceDate>\n\t\t<TaxInvoiceOpt>${fixed.TaxInvoiceOpt}</TaxInvoiceOpt>\n\t\t<TrxCode>${fixed.TrxCode}</TrxCode>\n\t\t<AddInfo/>\n\t\t<CustomDoc/>\n\t\t<CustomDocMonthYear/>\n\t\t<RefDesc>${xmlEscape(refDesc)}</RefDesc>\n\t\t<FacilityStamp/>\n\t\t<SellerIDTKU>${fixed.SellerIDTKU}</SellerIDTKU>\n\t\t<BuyerTin>${buyerTin}</BuyerTin>\n\t\t<BuyerDocument>${first.BuyerDocument||''}</BuyerDocument>\n\t\t<BuyerCountry>${fixed.BuyerCountry}</BuyerCountry>\n\t\t<BuyerDocumentNumber>${buyerDocNum}</BuyerDocumentNumber>\n\t\t<BuyerName>${xmlEscape(first.BuyerName)}</BuyerName>\n\t\t<BuyerAdress>${xmlEscape(first.BuyerAdress)}</BuyerAdress>\n\t\t<BuyerEmail>${xmlEscape(first.BuyerEmail)}</BuyerEmail>\n\t\t<BuyerIDTKU>${buyerIDTKU}</BuyerIDTKU>\n\t\t<ListOfGoodService>\n`;
        items.forEach(row => {
            const nk = k => k.replace(/\s+/g,'').toLowerCase();
            const fr = {};
            for (const k in row) {
                const nkk = nk(k);
                if (nkk==='price') fr.Price=row[k]; if (nkk==='qty') fr.Qty=row[k];
                if (nkk==='totaldisco'||nkk==='totaldiscount') fr.TotalDiscount=row[k];
                if (nkk==='taxbase') fr.TaxBase=row[k]; if (nkk==='type') fr.Type=row[k];
                if (nkk==='kodeobjekpajak'||nkk==='kodepajak'||nkk==='kop') fr.KodeObjekPajak=row[k];
                if (nkk==='name') fr.Name=row[k];
            }
            const price = xmlNum(fr.Price), qty = xmlNum(fr.Qty), discount = xmlNum(fr.TotalDiscount), vatRate = xmlNum(fr.VATRate||fixed.VATRate);
            let taxBase = xmlNum(fr.TaxBase);
            if (!taxBase) taxBase = Number((price*qty-discount).toFixed(2));
            const otherTaxBase = Number((taxBase*11/12).toFixed(2));
            const vat = Number((otherTaxBase*vatRate/100).toFixed(2));
            const codeObj = fr.KodeObjekPajak || fixed.Code;
            let opt = fixed.Opt;
            if (fr.Type) { const t = String(fr.Type).toLowerCase().trim(); if (t==='barang'||t==='a') opt='A'; else if (t==='jasa'||t==='b') opt='B'; }
            const unit = opt==='A' ? 'UM.0021' : 'UM.0033';
            xml += `\t\t\t<GoodService>\n\t\t\t\t<Opt>${opt}</Opt>\n\t\t\t\t<Code>${codeObj}</Code>\n\t\t\t\t<Name>${xmlEscape(fr.Name)}</Name>\n\t\t\t\t<Unit>${unit}</Unit>\n\t\t\t\t<Price>${price}</Price>\n\t\t\t\t<Qty>${qty}</Qty>\n\t\t\t\t<TotalDiscount>${discount}</TotalDiscount>\n\t\t\t\t<TaxBase>${taxBase.toFixed(2)}</TaxBase>\n\t\t\t\t<OtherTaxBase>${otherTaxBase.toFixed(2)}</OtherTaxBase>\n\t\t\t\t<VATRate>${vatRate.toFixed(2)}</VATRate>\n\t\t\t\t<VAT>${vat.toFixed(2)}</VAT>\n\t\t\t\t<STLGRate>${fixed.STLGRate}</STLGRate>\n\t\t\t\t<STLG>${fixed.STLG}</STLG>\n\t\t\t</GoodService>\n`;
        });
        xml += `\t\t</ListOfGoodService>\n\t</TaxInvoice>\n`;
    });
    xml += `\t</ListOfTaxInvoice>\n</TaxInvoiceBulk>`;
    xmlContent = xml;
    document.getElementById('xmlPreviewBox').textContent = xml;
    document.getElementById('xmlPreview').style.display = 'block';
    document.getElementById('xmlDownloadBtn').style.display = 'inline-flex';
    document.getElementById('xmlCopyBtn').style.display = 'inline-flex';
}

function xmlCopy() {
    navigator.clipboard.writeText(xmlContent).then(() => {
        const b = document.getElementById('xmlCopyBtn');
        const orig = b.innerHTML; b.innerHTML = '‚úì Copied!';
        setTimeout(() => b.innerHTML = orig, 2000);
    });
}

function xmlDownloadFile() {
    const blob = new Blob([xmlContent], {type:'application/xml;charset=utf-8'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `TaxInvoice_${xmlSelectedCompany}_${Date.now()}.xml`;
    a.click();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  TAB 2: MODE SWITCH
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function switchCalcMode(mode) {
    document.getElementById('calcModeBiasa').style.display     = mode === 'biasa'     ? 'block' : 'none';
    document.getElementById('calcModeGrossup').style.display   = mode === 'grossup'   ? 'block' : 'none';
    document.getElementById('calcModeProgresif').style.display = mode === 'progresif' ? 'block' : 'none';
    document.getElementById('calcModeImport').style.display    = mode === 'import'    ? 'block' : 'none';
    document.getElementById('modeBtnBiasa').classList.toggle('active',     mode === 'biasa');
    document.getElementById('modeBtnGrossup').classList.toggle('active',   mode === 'grossup');
    document.getElementById('modeBtnProgresif').classList.toggle('active', mode === 'progresif');
    document.getElementById('modeBtnImport').classList.toggle('active',    mode === 'import');
    if (mode === 'import') impUpdateInfo();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PPH 21 PROGRESIF ‚Äî Pasal 17 UU HPP No.7/2021
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const PROG_LAYERS = [
    { label: 's.d. Rp 60.000.000',                 rate: 0.05, cap: 60_000_000   },
    { label: '> Rp 60 jt s.d. Rp 250 jt',          rate: 0.15, cap: 190_000_000  },
    { label: '> Rp 250 jt s.d. Rp 500 jt',         rate: 0.25, cap: 250_000_000  },
    { label: '> Rp 500 jt s.d. Rp 5.000.000.000',  rate: 0.30, cap: 4_500_000_000},
    { label: '> Rp 5.000.000.000',                  rate: 0.35, cap: Infinity     },
];
const PROG_COLORS = ['var(--cyan)','var(--green)','var(--yellow)','var(--orange)','var(--pink)'];

function progFormatInput(el) {
    const raw = el.value.replace(/\D/g, '');
    el.value = raw ? parseInt(raw).toLocaleString('id-ID') : '';
}

function progFmt(n) {
    return 'Rp ' + Math.round(n).toLocaleString('id-ID');
}

function progHitung() {
    const raw  = document.getElementById('prog_pkp').value.replace(/\./g,'').replace(/\D/g,'');
    const pkp  = parseFloat(raw) || 0;
    const mult = parseFloat(document.getElementById('prog_npwp').value) || 1;

    const summaryEl   = document.getElementById('prog_summaryCards');
    const breakdownEl = document.getElementById('prog_breakdownWrap');
    const noteEl      = document.getElementById('prog_nonNpwpNote');
    const tbody       = document.getElementById('prog_tbody');
    const tfoot       = document.getElementById('prog_tfoot');

    if (pkp <= 0) {
        summaryEl.style.display = breakdownEl.style.display = noteEl.style.display = 'none';
        return;
    }

    let remaining = pkp, totalPph = 0, rows = '';

    PROG_LAYERS.forEach((layer, i) => {
        const taxable = Math.min(remaining, layer.cap);
        const pajak   = taxable > 0 ? taxable * layer.rate : 0;
        totalPph += pajak;
        const active  = taxable > 0;
        const rowBg   = i % 2 === 1 ? 'background:rgba(255,255,255,0.02);' : '';

        rows += `<tr style="${rowBg}opacity:${active?1:0.3};border-bottom:1px solid var(--border);">
            <td style="padding:9px 14px;color:var(--text);font-size:12px;">${layer.label}</td>
            <td style="padding:9px 14px;text-align:center;font-weight:700;color:${PROG_COLORS[i]};font-family:'IBM Plex Mono',monospace;">${(layer.rate*100).toFixed(0)}%</td>
            <td style="padding:9px 14px;text-align:right;font-family:'IBM Plex Mono',monospace;color:var(--text);">${active ? progFmt(taxable) : '‚Äì'}</td>
            <td style="padding:9px 14px;text-align:right;font-family:'IBM Plex Mono',monospace;color:${active?PROG_COLORS[i]:'var(--text-muted)'};">${active ? progFmt(pajak) : '‚Äì'}</td>
            <td style="padding:9px 14px;text-align:right;font-family:'IBM Plex Mono',monospace;color:var(--green);">${active ? progFmt(totalPph) : '‚Äì'}</td>
        </tr>`;
        remaining -= taxable;
    });

    tbody.innerHTML = rows;

    const finalPph   = totalPph * mult;
    const tarEfektif = (finalPph / pkp * 100).toFixed(2);
    const perBulan   = finalPph / 12;

    tfoot.innerHTML = `
        <tr style="background:linear-gradient(135deg,rgba(16,185,129,0.12),rgba(6,182,212,0.08));">
            <td colspan="3" style="padding:11px 14px;font-weight:700;color:var(--text);font-size:13px;">TOTAL PPh Normal</td>
            <td style="padding:11px 14px;text-align:right;font-weight:700;font-family:'IBM Plex Mono',monospace;color:var(--green);font-size:14px;">${progFmt(totalPph)}</td>
            <td style="padding:11px 14px;text-align:right;font-weight:700;font-family:'IBM Plex Mono',monospace;color:var(--green);font-size:14px;">${progFmt(totalPph)}</td>
        </tr>
        ${mult > 1 ? `<tr style="background:rgba(239,68,68,0.07);">
            <td colspan="3" style="padding:9px 14px;font-size:12px;color:#f87171;font-family:'IBM Plex Mono',monospace;">+ Non-NPWP Penalty (+20%)</td>
            <td style="padding:9px 14px;text-align:right;font-weight:700;font-family:'IBM Plex Mono',monospace;color:#f87171;">${progFmt(finalPph)}</td>
            <td style="padding:9px 14px;text-align:right;font-weight:700;font-family:'IBM Plex Mono',monospace;color:#f87171;">${progFmt(finalPph)}</td>
        </tr>` : ''}`;

    document.getElementById('prog_r_pkp').textContent     = progFmt(pkp);
    document.getElementById('prog_r_pph').textContent     = progFmt(finalPph);
    document.getElementById('prog_r_efektif').textContent = tarEfektif + '%';
    document.getElementById('prog_r_bulanan').textContent = progFmt(perBulan);

    summaryEl.style.display   = 'grid';
    breakdownEl.style.display = 'block';
    noteEl.style.display      = mult > 1 ? 'block' : 'none';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  TAB 2: KALKULATOR BIASA (DPP ‚Üí Pajak)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// Note: kb inputs are registered after guSetupInput is defined (see below)

function kbUpdatePPh23() {
    const v = document.getElementById('kb_jenisPPh23').value;
    document.getElementById('kb_customTarifPPh23Group').style.display = v==='custom'?'block':'none';
}
function kbUpdatePPh4() {
    const v = document.getElementById('kb_jenisPPh4').value;
    document.getElementById('kb_customTarifPPh4Group').style.display = v==='custom'?'block':'none';
}
function kbUpdatePPh22() {
    const v = document.getElementById('kb_jenisPPh22').value;
    document.getElementById('kb_customTarifPPh22Group').style.display = v==='custom'?'block':'none';
}
function kbUpdatePPN() {
    const v = document.getElementById('kb_tarifPPN').value;
    document.getElementById('kb_customTarifPPNGroup').style.display = v==='custom'?'block':'none';
}
function kbUpdatePPh15() {
    const v = document.getElementById('kb_jenisPPh15').value;
    document.getElementById('kb_customTarifPPh15Group').style.display = v==='custom'?'block':'none';
}

document.getElementById('kb_inputTypePPN').addEventListener('change', function() {
    document.getElementById('kb_labelPPN').textContent = this.value === 'total' ? 'Total Termasuk PPN (Rp)' : 'DPP (Rp)';
});

function kbShowResult(id, rows, cardColorVar, title) {
    const el = document.getElementById(id);
    const color = cardColorVar || 'var(--card-color)';
    const titleHtml = title ? `<div style="font-size:10px;font-family:'IBM Plex Mono',monospace;color:${color};letter-spacing:0.08em;text-transform:uppercase;margin-bottom:10px;">${title}</div>` : '';
    el.innerHTML = titleHtml + rows.map((r,i) => `<div class="result-row" style="${i===rows.length-1?'border-top:2px solid '+color+';border-bottom:none;margin-top:4px;padding-top:12px;':''}"><span class="result-label">${r[0]}</span><span class="result-value" style="${i===rows.length-1?'color:'+color+';font-size:15px;':''}">${r[1]}</span></div>`).join('');
    el.classList.add('show');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  TER PPh 21 ‚Äî PP 58/2023, berlaku Jan 2024
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const TER_TABLE = {
    A: [
        {max:5400000,rate:0},{max:5650000,rate:0.25},{max:5950000,rate:0.5},{max:6300000,rate:0.75},
        {max:6750000,rate:1},{max:7500000,rate:1.25},{max:8550000,rate:1.5},{max:9650000,rate:1.75},
        {max:10050000,rate:2},{max:10350000,rate:2.25},{max:10700000,rate:2.5},{max:11050000,rate:3},
        {max:11600000,rate:3},{max:12500000,rate:3.5},{max:13750000,rate:4},{max:15100000,rate:5},
        {max:16950000,rate:5.5},{max:19750000,rate:6},{max:24150000,rate:7},{max:26450000,rate:7.5},
        {max:28000000,rate:8},{max:30050000,rate:8.5},{max:32400000,rate:9},{max:35400000,rate:9.5},
        {max:39100000,rate:10},{max:43850000,rate:10.5},{max:47800000,rate:11},{max:51400000,rate:11.5},
        {max:56300000,rate:12},{max:62200000,rate:12.5},{max:68600000,rate:13},{max:77500000,rate:13.5},
        {max:89000000,rate:14},{max:103000000,rate:14.5},{max:125000000,rate:15},{max:157000000,rate:17},
        {max:206000000,rate:20},{max:337000000,rate:25},{max:454000000,rate:30},{max:Infinity,rate:35},
    ],
    B: [
        {max:6200000,rate:0},{max:6500000,rate:0.25},{max:6850000,rate:0.5},{max:7300000,rate:0.75},
        {max:9200000,rate:1},{max:10750000,rate:1.5},{max:11250000,rate:2},{max:11600000,rate:2.5},
        {max:12600000,rate:3},{max:13600000,rate:3.5},{max:14950000,rate:4},{max:16400000,rate:5},
        {max:18450000,rate:5.5},{max:21850000,rate:6},{max:26000000,rate:7},{max:27700000,rate:7.5},
        {max:29350000,rate:8},{max:31450000,rate:8.5},{max:33950000,rate:9},{max:37100000,rate:9.5},
        {max:41100000,rate:10},{max:45800000,rate:10.5},{max:49500000,rate:11},{max:53800000,rate:11.5},
        {max:58500000,rate:12},{max:64000000,rate:12.5},{max:71000000,rate:13},{max:80000000,rate:13.5},
        {max:93000000,rate:14},{max:109000000,rate:14.5},{max:129000000,rate:15},{max:163000000,rate:17},
        {max:211000000,rate:20},{max:374000000,rate:25},{max:459000000,rate:30},{max:Infinity,rate:35},
    ],
    C: [
        {max:6600000,rate:0},{max:6950000,rate:0.25},{max:7350000,rate:0.5},{max:7800000,rate:0.75},
        {max:8850000,rate:1},{max:9800000,rate:1.25},{max:10950000,rate:1.5},{max:11200000,rate:2},
        {max:12050000,rate:2.5},{max:12950000,rate:3},{max:14150000,rate:3.5},{max:15550000,rate:4},
        {max:17050000,rate:5},{max:19500000,rate:5.5},{max:22700000,rate:6},{max:26600000,rate:7},
        {max:28100000,rate:7.5},{max:30100000,rate:8},{max:32600000,rate:8.5},{max:35400000,rate:9},
        {max:38900000,rate:9.5},{max:43000000,rate:10},{max:47400000,rate:10.5},{max:51200000,rate:11},
        {max:55800000,rate:11.5},{max:60400000,rate:12},{max:66700000,rate:12.5},{max:74500000,rate:13},
        {max:83200000,rate:13.5},{max:95600000,rate:14},{max:110000000,rate:14.5},{max:134000000,rate:15},
        {max:169000000,rate:17},{max:221000000,rate:20},{max:390000000,rate:25},{max:463000000,rate:30},
        {max:Infinity,rate:35},
    ],
};

function getTerRate(kat, bruto) {
    for (const row of (TER_TABLE[kat] || TER_TABLE.A)) {
        if (bruto <= row.max) return row.rate;
    }
    return 35;
}

function kbToggleModePPh21() {
    const mode = document.getElementById('kb_modePPh21').value;
    document.getElementById('kb_ter_group').style.display   = mode === 'ter'   ? 'block' : 'none';
    document.getElementById('kb_tetap_group').style.display = mode === 'tetap' ? 'block' : 'none';
    document.getElementById('kb_resultPPh21').innerHTML = '';
    document.getElementById('kb_resultPPh21').classList.remove('show');
}

function guToggleModePPh21() {
    const mode = document.getElementById('gu_modePPh21').value;
    document.getElementById('gu_ter_group').style.display   = mode === 'ter'   ? 'block' : 'none';
    document.getElementById('gu_tetap_group').style.display = mode === 'tetap' ? 'block' : 'none';
    document.getElementById('gu_resultPPh21').innerHTML = '';
    document.getElementById('gu_resultPPh21').classList.remove('show');
}

function kbHitungPPh21() {
    const mode = document.getElementById('kb_modePPh21').value;
    if (mode === 'ter') {
        const bruto = guParseInput(document.getElementById('kb_ter_bruto').value);
        const kat   = document.getElementById('kb_terKategori').value;
        if (bruto <= 0) { alert('Masukkan penghasilan bruto yang valid!'); return; }
        const tarif = getTerRate(kat, bruto);
        const pajak = Math.round(bruto * tarif / 100);
        const nett  = bruto - pajak;
        kbShowResult('kb_resultPPh21', [
            ['Penghasilan Bruto',  guFormatRupiah(bruto)],
            ['Kategori TER',       'Kategori ' + kat],
            ['Tarif TER',          tarif.toFixed(2) + '%'],
            ['PPh 21 Dipotong',    guFormatRupiah(pajak)],
            ['Nett Diterima',      guFormatRupiah(nett)],
        ], 'var(--cyan)', 'üìÖ TER Bulanan ‚Äî PP 58/2023');
    } else {
        const dpp   = guParseInput(document.getElementById('kb_dppPPh21').value);
        const tarif = parseFloat(document.getElementById('kb_tarifPPh21').value);
        if (dpp <= 0) { alert('Masukkan nilai DPP yang valid!'); return; }
        const pajak = dpp * tarif / 100;
        const nett  = dpp - pajak;
        kbShowResult('kb_resultPPh21', [
            ['DPP / Bruto',     guFormatRupiah(dpp)],
            ['Tarif PPh 21',    tarif + '%'],
            ['PPh 21 Dipotong', guFormatRupiah(pajak)],
            ['Nett Diterima',   guFormatRupiah(nett)],
        ], 'var(--cyan)');
    }
}

function kbHitungPPh23() {
    const dpp = guParseInput(document.getElementById('kb_dppPPh23').value);
    const jenis = document.getElementById('kb_jenisPPh23').value;
    const tarif = jenis === 'custom' ? parseFloat(document.getElementById('kb_customTarifPPh23').value)||0 : 2;
    if (dpp <= 0) { alert('Masukkan nilai DPP yang valid!'); return; }
    const pajak = dpp * tarif / 100;
    const nett = dpp - pajak;
    kbShowResult('kb_resultPPh23', [
        ['DPP / Bruto', guFormatRupiah(dpp)],
        ['Tarif PPh 23', tarif + '%'],
        ['PPh 23 Dipotong', guFormatRupiah(pajak)],
        ['Nett Diterima', guFormatRupiah(nett)],
    ], 'var(--pink)');
}

function kbHitungPPh4() {
    const dpp = guParseInput(document.getElementById('kb_dppPPh4').value);
    const jenis = document.getElementById('kb_jenisPPh4').value;
    const tarif = jenis === 'custom' ? parseFloat(document.getElementById('kb_customTarifPPh4').value)||0 : parseFloat(jenis);
    if (dpp <= 0) { alert('Masukkan nilai DPP yang valid!'); return; }
    const pajak = dpp * tarif / 100;
    const nett = dpp - pajak;
    kbShowResult('kb_resultPPh4', [
        ['DPP / Bruto', guFormatRupiah(dpp)],
        ['Tarif PPh 4(2)', tarif + '%'],
        ['PPh 4(2) Dipotong', guFormatRupiah(pajak)],
        ['Nett Diterima', guFormatRupiah(nett)],
    ], 'var(--yellow)');
}

function kbHitungPPh22() {
    const nilai = guParseInput(document.getElementById('kb_dppPPh22').value);
    const jenis = document.getElementById('kb_jenisPPh22').value;
    const tarif = jenis === 'custom' ? parseFloat(document.getElementById('kb_customTarifPPh22').value)||0 : parseFloat(jenis);
    if (nilai <= 0) { alert('Masukkan nilai transaksi yang valid!'); return; }
    const pajak = nilai * tarif / 100;
    kbShowResult('kb_resultPPh22', [
        ['Nilai Transaksi / DPP', guFormatRupiah(nilai)],
        ['Tarif PPh 22', tarif + '%'],
        ['PPh 22 Dipungut', guFormatRupiah(pajak)],
    ], 'var(--purple)');
}

function kbHitungPPN() {
    const input = guParseInput(document.getElementById('kb_dppPPN').value);
    const tv = document.getElementById('kb_tarifPPN').value;
    const tarif = tv === 'custom' ? parseFloat(document.getElementById('kb_customTarifPPN').value)||0 : parseFloat(tv);
    const inputType = document.getElementById('kb_inputTypePPN').value;
    if (input <= 0) { alert('Masukkan nilai yang valid!'); return; }

    let dpp, ppn, total;
    if (inputType === 'total') {
        // Total sudah termasuk PPN ‚Üí ekstrak DPP
        // total = DPP + PPN = DPP + (DPP*nilaiLain*tarif/100)
        // Untuk tarif 12%: total = DPP + DPP*(11/12)*(12/100) = DPP * (1 + 11/100) = DPP * 1.11
        if (tarif === 12) {
            dpp = input / 1.11;
        } else {
            dpp = input / (1 + tarif/100);
        }
        ppn = input - dpp;
        total = input;
    } else {
        dpp = input;
        const dppNilaiLain = tarif === 12 ? dpp * 11/12 : dpp;
        ppn = dppNilaiLain * tarif / 100;
        total = dpp + ppn;
    }

    const dppNilaiLain = tarif === 12 ? dpp * 11/12 : dpp;
    kbShowResult('kb_resultPPN', [
        ['DPP', guFormatRupiah(dpp)],
        ['DPP Nilai Lain' + (tarif===12?' (11/12)':''), guFormatRupiah(dppNilaiLain)],
        ['Tarif PPN', tarif + '%'],
        ['PPN Terutang', guFormatRupiah(ppn)],
        ['Total (DPP + PPN)', guFormatRupiah(total)],
    ], 'var(--orange)');
}

function kbHitungPPh15() {
    const bruto = guParseInput(document.getElementById('kb_dppPPh15').value);
    const jenis = document.getElementById('kb_jenisPPh15').value;
    const tarif = jenis === 'custom' ? parseFloat(document.getElementById('kb_customTarifPPh15').value)||0 : parseFloat(jenis);
    if (bruto <= 0) { alert('Masukkan nilai peredaran bruto yang valid!'); return; }
    const pajak = bruto * tarif / 100;
    const nett = bruto - pajak;
    document.getElementById('kb_resultPPh15').innerHTML = [
        ['Peredaran Bruto', guFormatRupiah(bruto)],
        ['Tarif PPh 15', tarif + '%'],
        ['PPh 15 Dipotong', guFormatRupiah(pajak)],
        ['Nett Diterima', guFormatRupiah(nett)],
    ].map((r,i,arr) => `<div class="result-row" style="${i===arr.length-1?'border-top:2px solid var(--green);border-bottom:none;margin-top:4px;padding-top:12px;':''}"><span class="result-label">${r[0]}</span><span class="result-value" style="${i===arr.length-1?'color:var(--green);font-size:15px;':''}">${r[1]}</span></div>`).join('');
    document.getElementById('kb_resultPPh15').classList.add('show');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  TAB 2: GROSS UP CALCULATOR
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function guFormatRupiah(n) { return new Intl.NumberFormat('id-ID',{style:'currency',currency:'IDR',minimumFractionDigits:0}).format(n); }
function guFormatInput(s) { return s.toString().replace(/\B(?=(\d{3})+(?!\d))/g,'.'); }
function guParseInput(s) { return parseFloat(s.replace(/\./g,'').replace(/,/g,'.')) || 0; }

function guSetupInput(id) {
    const el = document.getElementById(id);
    el.addEventListener('input', e => {
        let v = e.target.value.replace(/[^\d.,]/g,'');
        const parts = v.replace(/\./g,'').split(',');
        if (parts[0]) parts[0] = guFormatInput(parts[0]);
        e.target.value = parts.length > 1 ? parts[0] + ',' + parts[1] : parts[0];
    });
    el.addEventListener('blur', e => { if (e.target.value) e.target.value = guFormatInput(guParseInput(e.target.value)); });
    el.addEventListener('keypress', e => { if (e.key==='Enter') { const card = el.closest('.calc-card, .kb-calc-card'); if(card) card.querySelector('.calc-btn').click(); } });
}

['gu_nettPPh21','gu_nettPPh23','gu_nettPPh4','gu_nettPPN','gu_ter_nett'].forEach(guSetupInput);
['kb_dppPPh21','kb_dppPPh23','kb_dppPPh4','kb_dppPPh22','kb_dppPPN','kb_dppPPh15','kb_ter_bruto'].forEach(guSetupInput);

function guUpdateTarifPPh23() {
    const v = document.getElementById('gu_jenisPPh23').value;
    document.getElementById('gu_customTarifPPh23Group').style.display = v==='custom' ? 'block':'none';
}
function guUpdateTarifPPh4() {
    const v = document.getElementById('gu_jenisPPh4').value;
    document.getElementById('gu_customTarifPPh4Group').style.display = v==='custom' ? 'block':'none';
}
function guUpdateTarifPPN() {
    const v = document.getElementById('gu_tarifPPN').value;
    document.getElementById('gu_customTarifPPNGroup').style.display = v==='custom' ? 'block':'none';
}

function guGrossUp(nett, tarif) {
    const dpp = nett / (1 - tarif/100);
    return { dpp, pajak: dpp - nett };
}

function guShowResult(id, nett, dpp, pajak, tarif) {
    const el = document.getElementById(id);
    el.innerHTML = `<div class="result-row"><span class="result-label">Jumlah Nett</span><span class="result-value">${guFormatRupiah(nett)}</span></div><div class="result-row"><span class="result-label">Tarif Pajak</span><span class="result-value">${tarif}%</span></div><div class="result-row"><span class="result-label">PPh Dipotong</span><span class="result-value">${guFormatRupiah(pajak)}</span></div><div class="result-row"><span class="result-label">DPP / Gross Up</span><span class="result-value">${guFormatRupiah(dpp)}</span></div>`;
    el.classList.add('show');
}

function guShowResultPPN(dpp, dppNilaiLain, ppn, total, tarif) {
    const el = document.getElementById('gu_resultPPN');
    el.innerHTML = `<div class="result-row"><span class="result-label">DPP</span><span class="result-value">${guFormatRupiah(dpp)}</span></div><div class="result-row"><span class="result-label">DPP Nilai Lain ${tarif===12?'(11/12)':''}</span><span class="result-value">${guFormatRupiah(dppNilaiLain)}</span></div><div class="result-row"><span class="result-label">PPN ${tarif}%</span><span class="result-value">${guFormatRupiah(ppn)}</span></div><div class="result-row"><span class="result-label">Total (DPP + PPN)</span><span class="result-value">${guFormatRupiah(total)}</span></div>`;
    el.classList.add('show');
}

function guHitungPPh21() {
    const mode = document.getElementById('gu_modePPh21').value;
    if (mode === 'ter') {
        const nett = guParseInput(document.getElementById('gu_ter_nett').value);
        const kat  = document.getElementById('gu_terKategori').value;
        if (nett <= 0) { alert('Masukkan jumlah nett yang valid!'); return; }
        // Gross up iteratif karena tarif TER bergantung pada bruto (lookup table)
        let bruto = nett;
        for (let i = 0; i < 30; i++) {
            const t = getTerRate(kat, bruto) / 100;
            const prev = bruto;
            bruto = t > 0 ? nett / (1 - t) : nett;
            if (Math.abs(bruto - prev) < 1) break;
        }
        bruto = Math.round(bruto);
        const tarif = getTerRate(kat, bruto);
        const pajak = Math.round(bruto * tarif / 100);
        const el = document.getElementById('gu_resultPPh21');
        el.innerHTML = `
            <div style="font-size:10px;font-family:'IBM Plex Mono',monospace;color:var(--cyan);letter-spacing:0.08em;text-transform:uppercase;margin-bottom:10px;">üìÖ Gross Up TER ‚Äî PP 58/2023</div>
            ${[
                ['Nett Diterima',      guFormatRupiah(nett)],
                ['Bruto (Gross Up)',   guFormatRupiah(bruto)],
                ['Kategori TER',       'Kategori ' + kat],
                ['Tarif TER',          tarif.toFixed(2) + '%'],
                ['PPh 21 Ditanggung',  guFormatRupiah(pajak)],
            ].map((r,i,a) => `<div class="result-row" style="${i===a.length-1?'border-top:2px solid var(--cyan);border-bottom:none;margin-top:4px;padding-top:12px;':''}">
                <span class="result-label">${r[0]}</span>
                <span class="result-value" style="${i===a.length-1?'color:var(--cyan);font-size:15px;':''}">${r[1]}</span>
            </div>`).join('')}`;
        el.classList.add('show');
    } else {
        const nett  = guParseInput(document.getElementById('gu_nettPPh21').value);
        const tarif = parseFloat(document.getElementById('gu_tarifPPh21').value);
        if (nett <= 0) { alert('Masukkan jumlah nett yang valid!'); return; }
        const { dpp, pajak } = guGrossUp(nett, tarif);
        guShowResult('gu_resultPPh21', nett, dpp, pajak, tarif);
    }
}

function guHitungPPh23() {
    const nett = guParseInput(document.getElementById('gu_nettPPh23').value);
    const jenis = document.getElementById('gu_jenisPPh23').value;
    const tarif = jenis==='custom' ? parseFloat(document.getElementById('gu_customTarifPPh23').value)||0 : 2;
    if (nett <= 0) { alert('Masukkan jumlah nett yang valid!'); return; }
    const { dpp, pajak } = guGrossUp(nett, tarif);
    guShowResult('gu_resultPPh23', nett, dpp, pajak, tarif);
}

function guHitungPPh4() {
    const nett = guParseInput(document.getElementById('gu_nettPPh4').value);
    const jenis = document.getElementById('gu_jenisPPh4').value;
    const tarif = jenis==='custom' ? parseFloat(document.getElementById('gu_customTarifPPh4').value)||0 : parseFloat(jenis);
    if (nett <= 0) { alert('Masukkan jumlah nett yang valid!'); return; }
    const { dpp, pajak } = guGrossUp(nett, tarif);
    guShowResult('gu_resultPPh4', nett, dpp, pajak, tarif);
}

function guHitungPPN() {
    const dpp = guParseInput(document.getElementById('gu_nettPPN').value);
    const tv = document.getElementById('gu_tarifPPN').value;
    const tarif = tv==='custom' ? parseFloat(document.getElementById('gu_customTarifPPN').value)||0 : parseFloat(tv);
    if (dpp <= 0) { alert('Masukkan jumlah DPP yang valid!'); return; }
    const dppNilaiLain = tarif===12 ? dpp*11/12 : dpp;
    const ppn = dppNilaiLain * tarif/100;
    guShowResultPPN(dpp, dppNilaiLain, ppn, dpp+ppn, tarif);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SHARED PDF UTILS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

function pdfReadAsArrayBuffer(file) {
    return new Promise((res, rej) => {
        const r = new FileReader();
        r.onload = e => res(e.target.result);
        r.onerror = rej;
        r.readAsArrayBuffer(file);
    });
}

// ‚îÄ‚îÄ Helper: parse Indonesian number string ‚Üí JS number ‚îÄ‚îÄ
// "146.234" ‚Üí 146234 | "2.925" ‚Üí 2925 | "2,5" ‚Üí 2.5 | "2" ‚Üí 2
function parseIDNum(str) {
    if (str === null || str === undefined || str === '') return '';
    const s = String(str).trim();
    if (!s) return '';
    const cleaned = s.replace(/\./g, '').replace(',', '.');
    const n = parseFloat(cleaned);
    return isNaN(n) ? '' : n;
}

// ‚îÄ‚îÄ Helper: apply accounting format #,##0.00 to all numeric cells in worksheet ‚îÄ‚îÄ
function applyNumFmt(ws) {
    if (!ws || !ws['!ref']) return;
    const range = XLSX.utils.decode_range(ws['!ref']);
    for (let R = range.s.r; R <= range.e.r; R++) {
        for (let C = range.s.c; C <= range.e.c; C++) {
            const addr = XLSX.utils.encode_cell({r: R, c: C});
            const cell = ws[addr];
            if (cell && cell.t === 'n') {
                cell.z = '#,##0.00';
            }
        }
    }
}

function buildFileManager(prefix, extractFn, headers) {
    let files = [], workbook = null;
    const ua = document.getElementById(prefix+'UploadArea');
    const fi = document.getElementById(prefix+'FileInput');
    const fl = document.getElementById(prefix+'FileList');
    const fitems = document.getElementById(prefix+'FileItems');
    const cb = document.getElementById(prefix+'ConvertBtn');
    const clr = document.getElementById(prefix+'ClearBtn');
    const prog = document.getElementById(prefix+'Progress');
    const progFill = document.getElementById(prefix+'ProgressFill');
    const progText = document.getElementById(prefix+'ProgressText');
    const resultArea = document.getElementById(prefix+'ResultArea');
    const previewArea = document.getElementById(prefix+'PreviewArea');
    const errBox = document.getElementById(prefix+'ErrorBox');

    if (ua) {
        ua.addEventListener('click', () => fi.click());
        ua.addEventListener('dragover', e => { e.preventDefault(); ua.classList.add('dragover'); });
        ua.addEventListener('dragleave', () => ua.classList.remove('dragover'));
        ua.addEventListener('drop', e => { e.preventDefault(); ua.classList.remove('dragover'); addFiles([...e.dataTransfer.files].filter(f=>f.type==='application/pdf')); });
        fi.addEventListener('change', e => addFiles([...e.target.files].filter(f=>f.type==='application/pdf')));
    }

    if (clr) clr.addEventListener('click', () => { files=[]; updateList(); });

    function addFiles(newFiles) {
        newFiles.forEach(f => { if (!files.some(x=>x.name===f.name&&x.size===f.size)) files.push(f); });
        updateList();
    }

    window[prefix+'RemoveFile'] = function(i) { files.splice(i,1); updateList(); };

    function updateList() {
        if (!files.length) { fl.style.display='none'; cb.style.display='none'; return; }
        fl.style.display = 'block'; cb.style.display = 'inline-flex';
        fitems.innerHTML = files.map((f,i) => `<div class="file-item"><div class="file-item-info"><div class="file-item-name">üìÑ ${f.name}</div><div class="file-item-size">${(f.size/1024/1024).toFixed(2)} MB</div></div><button class="file-remove-btn" onclick="${prefix}RemoveFile(${i})">‚úï</button></div>`).join('');
        errBox.style.display='none';
    }

    window[prefix+'Convert'] = async function() {
        if (!files.length) return;
        try {
            prog.style.display='block'; resultArea.style.display='none'; errBox.style.display='none';
            cb.style.display='none';
            let wb = XLSX.utils.book_new(), allData = [];
            const taxMode = document.getElementById(prefix+'_taxDocMode').checked;
            const merge = document.getElementById(prefix+'_mergePages').checked;
            const separate = document.getElementById(prefix+'_separateFiles').checked;
            const detect = document.getElementById(prefix+'_detectTables').checked;
            const smart = document.getElementById(prefix+'_smartCols').checked;

            if (taxMode) allData.push(headers);

            for (let idx=0; idx<files.length; idx++) {
                progFill.style.width = (idx/files.length*90)+'%';
                progText.textContent = `Memproses ${idx+1}/${files.length}: ${files[idx].name}`;
                const ab = await pdfReadAsArrayBuffer(files[idx]);
                const pdf = await pdfjsLib.getDocument({data: new Uint8Array(ab)}).promise;
                let fileData = [];
                for (let pg=1; pg<=pdf.numPages; pg++) {
                    const page = await pdf.getPage(pg);
                    const tc = await page.getTextContent();
                    const pd = pdfExtractPage(tc, detect, true, taxMode, smart, extractFn);
                    if (pd.length) fileData = fileData.concat(pd);
                }
                if (separate && fileData.length) {
                    let sd = taxMode ? [headers, ...fileData] : fileData;
                    const wsS = XLSX.utils.aoa_to_sheet(sd);
                    applyNumFmt(wsS);
                    XLSX.utils.book_append_sheet(wb, wsS, files[idx].name.replace('.pdf','').substring(0,31));
                } else if (merge) allData = allData.concat(fileData);
            }
            progFill.style.width='100%'; progText.textContent='Selesai!';
            if (merge && !separate && allData.length) { const wsM = XLSX.utils.aoa_to_sheet(allData); applyNumFmt(wsM); XLSX.utils.book_append_sheet(wb, wsM, 'Semua Data'); }
            workbook = wb;
            window[prefix+'Workbook'] = wb;
            prog.style.display='none'; cb.style.display='inline-flex'; resultArea.style.display='block';
            renderPreview(previewArea, allData.slice(0,15));
        } catch(e) {
            prog.style.display='none'; cb.style.display='inline-flex';
            errBox.style.display='block'; errBox.textContent='‚ùå Error: ' + e.message;
        }
    };

    window[prefix+'Download'] = function() {
        const wb = window[prefix+'Workbook'];
        if (wb) XLSX.writeFile(wb, `${prefix}_export_${Date.now()}.xlsx`);
    };
}

function pdfExtractPage(tc, detect, preserve, taxMode, smart, extractFn) {
    if (taxMode && detect) {
        const r = extractFn(tc.items);
        if (r.length) return r;
    }
    const items = tc.items;
    if (!detect) return items.filter(i=>i.str.trim()).map(i=>[i.str.trim()]);
    const lines = {};
    items.forEach(item => {
        const y = smart ? Math.round(item.transform[5]/2)*2 : Math.round(item.transform[5]);
        if (!lines[y]) lines[y]=[];
        lines[y].push({text:item.str.trim(), x:item.transform[4], width:item.width||0});
    });
    const data = [];
    Object.keys(lines).map(Number).sort((a,b)=>b-a).forEach(y => {
        lines[y].sort((a,b)=>a.x-b.x);
        if (!smart) { const r = lines[y].filter(i=>i.text).map(i=>i.text); if(r.length) data.push(r); return; }
        const row=[]; let cx=-1;
        lines[y].forEach(item => {
            if (!item.text) return;
            if (item.x-cx>30 || cx===-1) { row.push(item.text); cx=item.x+(item.width||0); }
            else if (row.length) row[row.length-1]+=' '+item.text;
        });
        if (row.length) data.push(row);
    });
    return data;
}

function renderPreview(container, data) {
    if (!data || !data.length) { container.innerHTML='<p style="color:var(--text-dim)">‚ö†Ô∏è Tidak ada data</p>'; return; }
    let html = '<div class="preview-table-wrap"><table class="preview-table">';
    data.forEach((row,i) => {
        html += '<tr>';
        (Array.isArray(row)?row:[row]).forEach(cell => {
            const s = String(cell||'');
            const tag = i===0 ? 'th':'td';
            html += `<${tag} title="${s.replace(/"/g,"'")}">${s.substring(0,45)}${s.length>45?'‚Ä¶':''}</${tag}>`;
        });
        html += '</tr>';
    });
    html += '</table></div>';
    container.innerHTML = html;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  TAB 3: PDF PPh21
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const pph21Headers = ['NOMOR','MASA PAJAK','NIK/NPWP','NAMA','KODE OBJEK PAJAK','OBJEK PAJAK','PENGHASILAN BRUTO','DPP (%)','TARIF (%)','PPh DIPOTONG','JENIS DOKUMEN','TANGGAL','NOMOR DOKUMEN','NPWP/NIK','NAMA PEMOTONG','TANGGAL PEMOTONGAN','STATUS BUKTI PEMOTONGAN/PEMUNGUTAN'];

function extractPPh21Data(items) {
    const textItems = items.map(i=>({text:i.str.trim(), x:Math.round(i.transform[4]), y:Math.round(i.transform[5])})).filter(i=>i.text);
    textItems.sort((a,b)=>b.y-a.y||a.x-b.x);
    const allText = textItems.map(i=>i.text).join(' ');
    const d = {};

    for (const item of textItems) { if (/^[0-9]{6,8}[A-Z]{1,2}$/.test(item.text)) { d.nomor=item.text; break; } }
    if (!d.nomor) for (const item of textItems) { if (/^[A-Z0-9]{8,9}$/.test(item.text)) { d.nomor=item.text; break; } }

    const masaM = allText.match(/(\d{2}-\d{4})/);
    if (masaM) d.masaPajak = masaM[1];

    const kodeM = allText.match(/(\d{2}-\d{3}-\d{2})(?=\s+[A-Za-z])/);
    if (kodeM) d.kodeObjekPajak = kodeM[1];

    for (const pat of [/(\d{2}-\d{3}-\d{2})\s+(.*?)(?=\s+\d{1,3}(?:\.\d{3})+\s+\d+\s+\d)/i, /B\.4\s+(.*?)(?=\s+B\.5)/i]) {
        const m = allText.match(pat);
        if (m && m[2||1] && (m[2||1]).length>=15) { d.objekPajak=(m[2]||m[1]).trim().replace(/\s+/g,' '); break; }
    }

    const finPats = [
        /(\d{1,3}(?:\.\d{3})*)\s+(\d{1,3}(?:\.\d{3})*)\s+(\d{1,2}(?:\.\d+)?)\s+(\d{1,3}(?:\.\d{3})*)/,
        /B\.4[^0-9]*(\d{1,3}(?:\.\d{3})*)[^0-9]*B\.5[^0-9]*(\d{1,3})[^0-9]*B\.6[^0-9]*(\d{1,2}(?:\.\d+)?)[^0-9]*B\.7[^0-9]*(\d{1,3}(?:\.\d{3})*)/i,
        /(\d{1,3}(?:\.\d{3})*)\s+(\d{1,2}(?:\.\d+)?)\s+(\d{1,3}(?:\.\d{3})*)/
    ];
    for (const p of finPats) {
        const m = allText.match(p);
        if (m) {
            if (m.length===5) { d.penghasilanBruto=m[1]; d.dpp=m[2]; d.tarif=m[3]; d.pajakPenghasilan=m[4]; }
            else if (m.length===4) { d.dpp=m[1]; d.tarif=m[2]; d.pajakPenghasilan=m[3]; }
            break;
        }
    }

    for (const p of [/Jenis\s+Dokumen\s*:\s*([^\n]+)/i]) { const m=allText.match(p); if(m) { d.jenisDokumen=m[1].replace(/\s*Tanggal.*/i,'').trim(); break; } }
    for (const p of [/Tanggal\s*:\s*(\d{1,2}\s+\w+\s+\d{4})/i, /(\d{1,2}\s+(?:Januari|Februari|Maret|April|Mei|Juni|Juli|Agustus|September|Oktober|November|Desember)\s+\d{4})/i]) { const m=allText.match(p); if(m) { d.tanggal=m[1].trim(); break; } }
    for (const p of [/Nomor\s+Dokumen\s*:\s*(CLM[A-Z0-9]+)/i, /Nomor\s+Dokumen\s*:\s*([A-Z0-9\.\-\/]+)/i]) { const m=allText.match(p); if(m) { d.nomorDokumen=m[1].trim().replace(/\s*NPWP.*$/i,'').replace(/\s*NIK.*$/i,'').trim(); break; } }
    for (const p of [/A\.1\s+(?:NIK|NPWP)[^:]*:\s*(\d{15,16})/i, /A\.1[^:]*:\s*(\d{15,16})/i]) { const m=allText.match(p); if(m&&(m[1].length===15||m[1].length===16)) { d.nikNpwpPenerima=m[1]; break; } }
    for (const p of [/A\.2\s+Nama\s*:\s*([A-Z][A-Z\s]+?)(?=A\.3|NITKU|$)/i]) { const m=allText.match(p); if(m) { d.namaPenerima=m[1].trim(); break; } }
    for (const p of [/C\.1\s+NPWP\s*\/\s*NIK\s*:\s*(\d{16})/i, /C\.[^0-9]*(\d{16})/i]) { const m=allText.match(p); if(m&&m[1].length===16) { d.npwpNik=m[1]; break; } }
    for (const p of [/C\.3\s+NAMA\s+PEMOTONG[^:]*:\s*([A-Z][A-Z\s,\.]+?)(?=C\.4|TANGGAL|$)/i]) { const m=allText.match(p); if(m) { d.namaPemotong=m[1].trim().replace(/\s+PPh$/i,''); break; } }
    for (const p of [/C\.4\s+TANGGAL\s*:\s*(\d{1,2}\s+\w+\s+\d{4})/i]) { const m=allText.match(p); if(m) { d.tanggalPemotongan=m[1].trim(); break; } }
    for (const p of [/\b(NORMAL|DIBATALKAN|PEMBETULAN)\b/i]) { const m=allText.match(p); if(m) { d.statusBukti=m[1]; break; } }

    const row = [d.nomor||'',d.masaPajak||'',d.nikNpwpPenerima||'',d.namaPenerima||'',d.kodeObjekPajak||'',d.objekPajak||'',parseIDNum(d.penghasilanBruto),parseIDNum(d.dpp),parseIDNum(d.tarif),parseIDNum(d.pajakPenghasilan),d.jenisDokumen||'',d.tanggal||'',d.nomorDokumen||'',d.npwpNik||'',d.namaPemotong||'',d.tanggalPemotongan||'',d.statusBukti||''];
    return row.some(c=>(c!==null&&c!==''&&c!==undefined&&String(c).length>0)) ? [row] : [];
}

buildFileManager('pph21', extractPPh21Data, pph21Headers);

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  TAB 4: PDF BPPU
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const bppuHeaders = ['NOMOR','MASA PAJAK','NPWP/NIK YANG DIPOTONG','NAMA YANG DIPOTONG','KODE OBJEK PAJAK','OBJEK PAJAK','DPP','TARIF','PAJAK PENGHASILAN','JENIS DOKUMEN','TANGGAL','NOMOR DOKUMEN','NPWP/NIK PEMOTONG','NAMA PEMOTONG','TANGGAL PEMOTONGAN','STATUS BUKTI PEMOTONGAN/PEMUNGUTAN'];

function extractBPPUData(items) {
    const textItems = items.map(i=>({text:i.str.trim(), x:Math.round(i.transform[4]), y:Math.round(i.transform[5])})).filter(i=>i.text);
    textItems.sort((a,b)=>b.y-a.y||a.x-b.x);
    const allText = textItems.map(i=>i.text).join(' ');
    const d = {};

    // ‚îÄ‚îÄ Nomor BPPU ‚Äî multi-format support (lama + Coretax) ‚îÄ‚îÄ
    const SKIP_NOMOR = /^(NORMAL|DIBATALKAN|PEMBETULAN|NPWP|NIK|NAMA|MASA|PAJAK|BUKTI|NOMOR|JENIS|TANGGAL|STATUS|TARIF|DPP|PPH|PEMOTONGAN|PEMUNGUTAN|UNIFIKASI|BERFORMAT|STANDAR|FINAL|TIDAK|INDONESIA|KEMENTERIAN|KEUANGAN|DIREKTORAT|JENDERAL|BPPU|PPH|DAN|ATAU|SIFAT|IDENTITAS)$/i;

    // 1. Format Coretax baru: campuran digit+huruf, diawali digit, 7-12 karakter (contoh: 2600I9CGO)
    for (const item of textItems) {
        if (/^[0-9]{2,5}[A-Z0-9]{4,8}$/.test(item.text) && /[A-Z]/.test(item.text) && /[0-9]/.test(item.text) && !SKIP_NOMOR.test(item.text)) {
            d.nomor = item.text; break;
        }
    }
    // 2. Format lama: 6-8 digit diakhiri 1-2 huruf (contoh: 12345678AB)
    if (!d.nomor) {
        for (const item of textItems) { if (/^[0-9]{6,8}[A-Z]{1,2}$/.test(item.text)) { d.nomor=item.text; break; } }
    }
    // 3. Cari tepat setelah kolom NOMOR di tabel (posisi X dekat, Y lebih rendah)
    if (!d.nomor) {
        const nomorHeader = textItems.find(i => /^NOMOR$/.test(i.text));
        if (nomorHeader) {
            const candidates = textItems.filter(i =>
                i.y < nomorHeader.y &&
                Math.abs(i.x - nomorHeader.x) < 80 &&
                /^[A-Z0-9]{6,15}$/.test(i.text) &&
                !SKIP_NOMOR.test(i.text)
            );
            if (candidates.length) d.nomor = candidates[0].text;
        }
    }
    // 4. Cari label "Nomor :" di teks
    if (!d.nomor) {
        const nomorLabelM = allText.match(/(?:^|\s)Nomor\s*:\s*([A-Z0-9\-\/\.]{6,25})(?=\s|$)/im);
        if (nomorLabelM && !SKIP_NOMOR.test(nomorLabelM[1])) d.nomor = nomorLabelM[1].trim();
    }
    // 5. Fallback: token alfanumerik bersih 6‚Äì15 karakter di 50 item pertama
    if (!d.nomor) {
        for (const item of textItems.slice(0, 50)) {
            if (/^[A-Z0-9]{6,15}$/.test(item.text) && !SKIP_NOMOR.test(item.text)) { d.nomor=item.text; break; }
        }
    }

    const masaM = allText.match(/(\d{2}-\d{4})/);
    if (masaM) d.masaPajak = masaM[1];

    const kodeM = allText.match(/(\d{2}-\d{3}-\d{2})(?=\s+[A-Za-z])/);
    if (kodeM) d.kodeObjekPajak = kodeM[1];

    const fallbackM = allText.match(/\d{2}-\d{3}-\d{2}\s+([A-Za-z][\s\S]+?)(?=\s+\d{1,3}(?:\.\d{3})+)/i);
    if (fallbackM && fallbackM[1]?.length >= 10) d.objekPajak = fallbackM[1].trim().replace(/\s+/g,' ');

    const finPats = [
        /(\d{1,3}(?:\.\d{3})*)\s+(\d{1,2}(?:\.\d+)?)\s+(\d{1,3}(?:\.\d{3})*)/,
        /B\.5[^0-9]*(\d{1,3}(?:\.\d{3})*)[^0-9]*B\.6[^0-9]*(\d{1,2}(?:\.\d+)?)[^0-9]*B\.7[^0-9]*(\d{1,3}(?:\.\d{3})*)/i
    ];
    for (const p of finPats) {
        const m = allText.match(p);
        if (m) { d.dpp=m[1]; d.tarif=m[2]; d.pajakPenghasilan=m[3]; break; }
    }

    for (const p of [/Jenis\s+Dokumen\s*:\s*([^\n]+)/i]) { const m=allText.match(p); if(m) { d.jenisDokumen=m[1].trim(); break; } }
    for (const p of [/(\d{1,2}\s+(?:Januari|Februari|Maret|April|Mei|Juni|Juli|Agustus|September|Oktober|November|Desember)\s+\d{4})/i]) { const m=allText.match(p); if(m) { d.tanggal=m[1].trim(); break; } }
    for (const p of [/B\.9\s+Nomor\s+Dokumen\s*:\s*([^\nB]+)/i, /Nomor\s+Dokumen\s*:\s*([^\nB]+)/i]) { const m=allText.match(p); if(m) { d.nomorDokumen=m[1].replace(/^NO\.?\s*/i,'').replace(/B$/,'').trim(); break; } }
    for (const p of [/C\.1\s+NPWP\s*\/\s*NIK\s*:\s*(\d{16})/i, /C\.[^0-9]*(\d{16})/i]) { const m=allText.match(p); if(m&&m[1].length===16) { d.npwpNik=m[1]; break; } }
    for (const p of [/C\.3\s+NAMA\s+PEMOTONG[^:]*:\s*([A-Z][A-Z\s,\.]+?)(?=C\.4|TANGGAL|$)/i]) { const m=allText.match(p); if(m) { d.namaPemotong=m[1].trim().replace(/\s+PPh$/i,''); break; } }
    for (const p of [/C\.4\s+TANGGAL\s*:\s*(\d{1,2}\s+\w+\s+\d{4})/i]) { const m=allText.match(p); if(m) { d.tanggalPemotongan=m[1].trim(); break; } }
    for (const p of [/\b(NORMAL|DIBATALKAN|PEMBETULAN)\b/i]) { const m=allText.match(p); if(m) { d.statusBukti=m[1]; break; } }

    // A.1 NPWP/NIK dipotong
    for (const p of [/A\.1\s+NPWP\s*\/\s*NIK\s*:\s*(\d{15,16})/i, /A\.1[^0-9]*(\d{15,16})/i]) { const m=allText.match(p); if(m&&(m[1].length===15||m[1].length===16)) { d.npwpDipotong=m[1]; break; } }
    if (!d.npwpDipotong) { const all=[...allText.matchAll(/\b(\d{15,16})\b/g)]; if(all.length) d.npwpDipotong=all[0][1]; }
    // A.2 Nama dipotong
    for (const p of [/A\.2\s+NAMA\s*:\s*([A-Z][A-Z\s,\.]+?)(?=\s*A\.3|\s*NOMOR\s+IDENTITAS|\s*NITKU|$)/i]) { const m=allText.match(p); if(m) { d.namaDipotong=m[1].trim().replace(/\s+/g,' '); break; } }

    const row = [d.nomor||'',d.masaPajak||'',d.npwpDipotong||'',d.namaDipotong||'',d.kodeObjekPajak||'',d.objekPajak||'',parseIDNum(d.dpp),parseIDNum(d.tarif),parseIDNum(d.pajakPenghasilan),d.jenisDokumen||'',d.tanggal||'',d.nomorDokumen||'',d.npwpNik||'',d.namaPemotong||'',d.tanggalPemotongan||'',d.statusBukti||''];
    return row.some(c=>(c!==null&&c!==''&&c!==undefined&&String(c).length>0)) ? [row] : [];
}

buildFileManager('bppu', extractBPPUData, bppuHeaders);

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  TAB 5: FAKTUR PAJAK CORETAX
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let fpUploadedFiles = [], fpExtractedData = [];

(function() {
    const ub = document.getElementById('fpUploadBox');
    const fi = document.getElementById('fpFileInput');
    ub.addEventListener('click', () => fi.click());
    ub.addEventListener('dragover', e => { e.preventDefault(); ub.classList.add('dragover'); });
    ub.addEventListener('dragleave', () => ub.classList.remove('dragover'));
    ub.addEventListener('drop', e => { e.preventDefault(); ub.classList.remove('dragover'); fpAddFiles([...e.dataTransfer.files].filter(f=>f.type==='application/pdf')); });
    fi.addEventListener('change', e => fpAddFiles([...e.target.files]));
})();

function fpAddFiles(files) {
    files.forEach(f => { if (!fpUploadedFiles.some(x=>x.name===f.name&&x.size===f.size)) fpUploadedFiles.push(f); });
    fpUpdateFileInfo();
}

function fpUpdateFileInfo() {
    const status = document.getElementById('fpStatus');
    const processBtn = document.getElementById('fpProcessBtn');
    const fi = document.getElementById('fpFileInfo');
    if (!fpUploadedFiles.length) { status.textContent='Belum ada file yang dipilih'; processBtn.disabled=true; fi.innerHTML=''; return; }
    processBtn.disabled=false;
    fi.innerHTML = fpUploadedFiles.map((f,i) => `<div class="file-item"><div class="file-item-info"><div class="file-item-name">üìÑ ${f.name}</div><div class="file-item-size">${(f.size/1024/1024).toFixed(2)} MB</div></div><button class="file-remove-btn" onclick="fpRemove(${i})">‚úï</button></div>`).join('');
    status.textContent = `${fpUploadedFiles.length} file siap diproses`;
}

function fpRemove(i) { fpUploadedFiles.splice(i,1); fpUpdateFileInfo(); }

async function fpProcess() {
    const statusEl = document.getElementById('fpStatus');
    statusEl.innerHTML = '<span class="loading" style="display:inline-block;width:16px;height:16px;border:2px solid var(--border2);border-top-color:var(--accent);border-radius:50%;animation:spin 1s linear infinite;margin-right:8px;vertical-align:middle;"></span>Memproses...';
    fpExtractedData = [];

    const results = [];
    try {
        for (let idx=0; idx<fpUploadedFiles.length; idx++) {
            const file = fpUploadedFiles[idx];
            statusEl.textContent = `Memproses ${idx+1}/${fpUploadedFiles.length}: ${file.name}`;
            const result = await fpProcessPDF(file);
            results.push(result);
        }

        const successCount = results.filter(r=>r.success).length;
        const failedCount  = results.filter(r=>!r.success).length;
        const totalItems   = fpExtractedData.length;

        let msg = `‚úÖ Berhasil: ${successCount} file (${totalItems} baris data)`;
        if (failedCount > 0) msg += ` | ‚ùå Gagal: ${failedCount} file`;

        let detail = '<div style="margin-top:8px;font-size:12px;">';
        results.forEach(r => {
            detail += r.success
                ? `<div style="color:var(--green);">‚úÖ ${r.file}: ${r.items} item</div>`
                : `<div style="color:#f87171;">‚ùå ${r.file}: Gagal ekstrak${r.error?' ('+r.error+')':''}</div>`;
        });
        detail += '</div>';
        statusEl.innerHTML = msg + detail;

        if (totalItems > 0) {
            fpDisplayResults();
            document.getElementById('fpResultSection').style.display='block';
            document.getElementById('fpDownloadBtn').style.display='inline-flex';
            document.getElementById('fpClearBtn').style.display='inline-flex';
        } else {
            statusEl.innerHTML = '‚ùå Tidak ada data berhasil diekstrak. Periksa format PDF.';
        }
    } catch(e) {
        statusEl.textContent = '‚ùå Error: '+e.message;
    }
}

async function fpProcessPDF(file) {
    try {
        const ab = await pdfReadAsArrayBuffer(file);
        const pdf = await pdfjsLib.getDocument({data: new Uint8Array(ab)}).promise;

        let fullText = '';
        for (let pg = 1; pg <= pdf.numPages; pg++) {
            const page = await pdf.getPage(pg);
            const tc   = await page.getTextContent();
            let lastY  = null;
            const pageLines = [];
            let curLine = [];
            tc.items.forEach(item => {
                const y = item.transform[5];
                if (lastY !== null && Math.abs(y - lastY) > 2) {
                    if (curLine.length) { pageLines.push(curLine.join(' ')); curLine = []; }
                }
                curLine.push(item.str);
                lastY = y;
            });
            if (curLine.length) pageLines.push(curLine.join(' '));
            fullText += pageLines.join('\n') + '\n\n<<<PAGE_BREAK>>>\n\n';
        }

        const chunks = fpSplitInvoices(fullText);
        let totalExtracted = 0;
        chunks.forEach((chunk, idx) => {
            const before = fpExtractedData.length;
            fpExtractFromText(chunk, `${file.name} (Invoice ${idx+1})`);
            totalExtracted += fpExtractedData.length - before;
        });

        if (totalExtracted === 0) return { file: file.name, success: false, items: 0 };
        return { file: file.name, success: true, items: totalExtracted };
    } catch(e) {
        return { file: file.name, success: false, items: 0, error: e.message };
    }
}

function fpSplitInvoices(fullText) {
    const chunks = [];
    // Split by "X dari Y" end-of-invoice markers
    const endMarkerRegex = /\d+\s+dari\s+\d+/gi;
    const endPositions = [];
    let match;
    while ((match = endMarkerRegex.exec(fullText)) !== null) {
        endPositions.push(match.index + match[0].length);
    }

    if (endPositions.length === 0) {
        // Fallback: split by FAKTUR PAJAK headers
        const markerPositions = [];
        const markerRe = /FAKTUR\s+PAJAK/gi;
        while ((match = markerRe.exec(fullText)) !== null) markerPositions.push(match.index);
        if (markerPositions.length === 0) return [fullText];
        for (let i = 0; i < markerPositions.length; i++) {
            const chunk = fullText.substring(markerPositions[i], i < markerPositions.length-1 ? markerPositions[i+1] : fullText.length);
            if (chunk.trim().length > 100) chunks.push(chunk);
        }
    } else {
        let lastEnd = 0;
        for (const endPos of endPositions) {
            const chunk = fullText.substring(lastEnd, endPos);
            if (chunk.includes('Faktur Pajak') || chunk.includes('FAKTUR PAJAK')) chunks.push(chunk.trim());
            lastEnd = endPos;
        }
        const remaining = fullText.substring(lastEnd);
        if (remaining.includes('Faktur Pajak') || remaining.includes('FAKTUR PAJAK')) chunks.push(remaining.trim());
    }
    return chunks.length > 0 ? chunks : [fullText];
}

function fpExtractFromText(text, filename) {
    text = text.replace(/\r\n/g,'\n').replace(/\r/g,'\n');

    // ‚îÄ‚îÄ Nomor Faktur ‚îÄ‚îÄ
    // Format Coretax: 16 digit angka (bisa juga diawali 0)
    let nomorFaktur = '';
    const nomorPatterns = [
        /Kode dan Nomor Seri Faktur Pajak[:\s]+(\d+)/i,
        /Nomor Seri Faktur Pajak[:\s]+(\d+)/i,
        /Faktur Pajak[:\s]+(\d{16,})/i,
        /#(\d{15,})/,
        /\b(\d{16})\b/
    ];
    for (const pat of nomorPatterns) {
        const m = text.match(pat);
        if (m) { nomorFaktur = m[1]; break; }
    }

    // ‚îÄ‚îÄ Penjual ‚îÄ‚îÄ
    let namaPenjual = '';
    const penjualPatterns = [
        /Pengusaha Kena Pajak[:\s]+Nama[:\s]+([^\n]+)/i,
        /PKP[:\s]+Nama[:\s]+([^\n]+)/i,
        /Nama[:\s]*:([^\n]+?)(?=Alamat|NPWP)/i
    ];
    for (const pat of penjualPatterns) {
        const m = text.match(pat);
        if (m) {
            namaPenjual = m[1].trim().split(/\s+(?:Alamat|NPWP|#)/i)[0].trim();
            if (namaPenjual.length > 3) break;
        }
    }

    const npwpPenjualM = text.match(/Pengusaha\s+Kena\s+Pajak[\s\S]*?NPWP\s*:\s*([\d.]+)/i);
    const npwpPenjual  = npwpPenjualM ? npwpPenjualM[1].replace(/\D/g,'') : '';

    // ‚îÄ‚îÄ Pembeli ‚îÄ‚îÄ
    let namaPembeli = '';
    const pembeliPatterns = [
        /Pembeli Barang Kena Pajak[\/\s]*Penerima Jasa Kena Pajak[:\s]+Nama[:\s]+([^\n]+)/i,
        /Pembeli.*?Nama[:\s]+([^\n]+)/i,
        /Penerima.*?Nama[:\s]+([^\n]+)/i
    ];
    for (const pat of pembeliPatterns) {
        const m = text.match(pat);
        if (m) {
            namaPembeli = m[1].trim().split(/\s+(?:Alamat|NPWP|#)/i)[0].trim();
            if (namaPembeli.length > 3) break;
        }
    }

    let npwpPembeli = '';
    const nikM = text.match(/NIK\s*:\s*(\d{16})/i);
    if (nikM) {
        npwpPembeli = nikM[1];
    } else {
        const npwpM = text.match(/Pembeli\s+Barang\s+Kena\s+Pajak\/Penerima\s+Jasa\s+Kena\s+Pajak[\s\S]*?NPWP\s*:\s*([\d.]+)/i);
        if (npwpM) {
            const cleaned = npwpM[1].replace(/\D/g,'');
            if (!/^0+$/.test(cleaned)) npwpPembeli = cleaned;
        }
    }

    // ‚îÄ‚îÄ Referensi ‚îÄ‚îÄ
    let referensi = '';
    const refPatterns = [
        /\(Referensi:\s*([^\)]+)\)/i,
        /\(Referensi\s+([^\)]+)\)/i,
        /Referensi:\s*([^\n\)]+)/i,
        /Referensi\s+([A-Z0-9\-]+)/i
    ];
    for (const pat of refPatterns) {
        const m = text.match(pat);
        if (m) { referensi = m[1].trim().replace(/[\)\s]+$/,''); if (referensi.length > 0) break; }
    }

    // ‚îÄ‚îÄ Items: SUPER AGGRESSIVE ‚Äî scan Rp price √ó qty patterns ‚îÄ‚îÄ
    const itemsFound = [];
    const compactPat = /Rp\s*([\d.,]+)\s*[xX√ó]\s*([\d.,]+)(?:\s*(?:Bulan|Lainnya|Hari|Unit|Pcs|Piece))?/gi;
    const priceMatches = [];
    let m;
    while ((m = compactPat.exec(text)) !== null) {
        priceMatches.push({ index: m.index, harga: m[1], qty: m[2] });
    }

    for (const pm of priceMatches) {
        const beforeText = text.substring(Math.max(0, pm.index - 300), pm.index);
        const afterText  = text.substring(pm.index, Math.min(text.length, pm.index + 300));

        let namaBarang = '';
        for (const np of [/(\d{1,3})\s+(\d{6})\s+([^\n]+?)$/, /(\d{1,3})\s+([^\n]+?)$/]) {
            const nm = beforeText.match(np);
            if (nm) {
                namaBarang = nm[nm.length-1].trim().replace(/^\d{6}\s+/,'').trim();
                if (namaBarang.length > 2) break;
            }
        }

        const discM    = afterText.match(/Potongan Harga\s*=\s*Rp\s*([\d.,]+)/i);
        const discount = discM ? parseFloat(discM[1].replace(/\./g,'').replace(',','.')) : 0;

        if (namaBarang) {
            namaBarang = namaBarang
                .replace(/\d{6,}/g,'').replace(/\s*Rp\s*[\d.,]+.*$/i,'')
                .replace(/Potongan.*/i,'').replace(/PPnBM.*/i,'')
                .replace(/\s+/g,' ').trim();

            if (namaBarang.length > 2) {
                const harga = parseFloat(pm.harga.replace(/\./g,'').replace(',','.'));
                const qty   = parseFloat(pm.qty.replace(/\./g,'').replace(',','.'));
                if (!isNaN(harga) && !isNaN(qty) && harga > 0 && qty > 0) {
                    const total = (harga * qty) - discount;
                    const ppn   = total * 0.11;
                    itemsFound.push({nomorFaktur,namaPenjual,npwpPenjual,namaBarang,harga,qty,discount,total,ppn,namaPembeli,npwpPembeli,referensi});
                }
            }
        }
    }

    // ‚îÄ‚îÄ Fallback: line-by-line ‚îÄ‚îÄ
    if (itemsFound.length === 0) {
        const lines = text.split('\n').map(l=>l.trim()).filter(l=>l.length>0);
        for (let i=0; i<lines.length; i++) {
            const line = lines[i];
            const itemNumM = line.match(/^(\d{1,3})\s+/);
            if (!itemNumM || parseInt(itemNumM[1]) >= 100) continue;
            let block = line;
            for (let j=i+1; j<Math.min(i+10,lines.length); j++) {
                const next = lines[j];
                block += ' ' + next;
                if (j>i+1 && next.match(/^\d{1,3}\s+/)) break;
                if (next.match(/PPnBM/i)) break;
            }
            let namaBarang='', hargaStr='', qtyStr='', matched=false;
            for (const pat of [
                /^(\d+)\s+(\d{6})\s+(.+?)\s+Rp\s*([\d.,]+)\s*[xX√ó]\s*([\d.,]+)\s*(?:Piece|piece)/i,
                /^(\d+)\s+([^R]+?)\s+Rp\s*([\d.,]+)\s*[xX√ó]\s*([\d.,]+)\s*(?:Piece|piece)/i
            ]) {
                const bm = block.match(pat);
                if (bm) {
                    namaBarang = pat.toString().includes('(\\d{6})') ? bm[3] : bm[2];
                    hargaStr   = pat.toString().includes('(\\d{6})') ? bm[4] : bm[3];
                    qtyStr     = pat.toString().includes('(\\d{6})') ? bm[5] : bm[4];
                    matched=true; break;
                }
            }
            const discM = block.match(/Potongan Harga\s*=\s*Rp\s*([\d.,]+)/i);
            if (matched && discM && namaBarang) {
                namaBarang = namaBarang.replace(/\d{6,}/g,'').replace(/\s*Rp\s*[\d.,]+.*$/i,'').replace(/Potongan.*/i,'').replace(/PPnBM.*/i,'').replace(/\s+/g,' ').trim();
                if (namaBarang.length>2) {
                    const harga = parseFloat(hargaStr.replace(/\./g,'').replace(',','.'));
                    const qty   = parseFloat(qtyStr.replace(/\./g,'').replace(',','.'));
                    const disc  = parseFloat(discM[1].replace(/\./g,'').replace(',','.'));
                    if (!isNaN(harga)&&!isNaN(qty)&&!isNaN(disc)&&harga>0&&qty>0) {
                        const total = harga*qty-disc;
                        itemsFound.push({nomorFaktur,namaPenjual,npwpPenjual,namaBarang,harga,qty,discount:disc,total,ppn:total*0.11,namaPembeli,npwpPembeli,referensi});
                    }
                }
            }
        }
    }

    // ‚îÄ‚îÄ Fallback SINGLE ITEM ‚îÄ‚îÄ
    if (itemsFound.length === 0) {
        let namaBarangFallback = '';
        const nbM = text.match(/No\.\s*Kode\s*Barang\/\s*Jasa[\s\S]*?\d+\s+\d+\s+([\s\S]+?)\s+Rp/i);
        if (nbM) {
            namaBarangFallback = nbM[1]
                .replace(/Potongan Harga.*$/i,'').replace(/Nama Barang Kena Pajak \/ Jasa Kena Pajak/i,'')
                .replace(/PPnBM.*$/i,'').replace(/\s+/g,' ').trim();
        }
        const tahunM = text.match(/\b(20\d{2})\b/);
        if (tahunM && namaBarangFallback && !namaBarangFallback.includes(tahunM[1])) {
            namaBarangFallback += ' ' + tahunM[1];
        }

        const itemM = text.match(/Rp\s*([\d.,]+)\s*[xX√ó]\s*([\d.,]+)\s*(?:Bulan|Lainnya|Hari|Unit|Pcs|Piece)?/i);
        const dppM  = text.match(/Dasar Pengenaan Pajak\s+([\d.,]+)/i);
        if (itemM) {
            const harga = parseFloat(itemM[1].replace(/\./g,'').replace(',','.'));
            const qty   = parseFloat(itemM[2].replace(/\./g,'').replace(',','.'));
            const total = harga * qty;
            const dpp   = dppM ? parseFloat(dppM[1].replace(/\./g,'').replace(',','.')) : total*11/12;
            const ppn   = dpp * 0.12;
            itemsFound.push({nomorFaktur,namaPenjual,npwpPenjual,namaBarang:namaBarangFallback||'Jasa / Barang (Single Item)',harga,qty,discount:0,total,ppn,namaPembeli,npwpPembeli,referensi});
        }
    }

    fpExtractedData.push(...itemsFound);
}

function fpDisplayResults() {
    const tbody = document.getElementById('fpResultBody');
    tbody.innerHTML = fpExtractedData.map(r => `<tr>
        <td>${r.nomorFaktur}</td><td>${r.namaPenjual}</td><td>${r.npwpPenjual}</td>
        <td>${r.namaBarang}</td><td>Rp ${r.harga.toLocaleString('id-ID')}</td>
        <td>${r.qty}</td><td>Rp ${r.discount.toLocaleString('id-ID')}</td>
        <td>Rp ${r.total.toLocaleString('id-ID')}</td><td>Rp ${r.ppn.toLocaleString('id-ID')}</td>
        <td>${r.namaPembeli}</td><td>${r.npwpPembeli}</td><td>${r.referensi}</td>
    </tr>`).join('');
}

function fpDownload() {
    const ws_data = [['No. Faktur Pajak','Nama Penjual','NPWP Penjual','Nama Barang','Harga','Qty','Discount','Total','PPN','Nama Pembeli','NPWP Pembeli','Referensi']];
    fpExtractedData.forEach(r => ws_data.push([r.nomorFaktur,r.namaPenjual,r.npwpPenjual,r.namaBarang,r.harga,r.qty,r.discount,r.total,r.ppn,r.namaPembeli,r.npwpPembeli,r.referensi]));
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet(ws_data);
    ws['!cols'] = [{wch:20},{wch:30},{wch:20},{wch:40},{wch:15},{wch:10},{wch:15},{wch:15},{wch:15},{wch:30},{wch:20},{wch:20}];
    applyNumFmt(ws);
    XLSX.utils.book_append_sheet(wb, ws, 'Faktur Pajak');
    XLSX.writeFile(wb, 'Faktur_Pajak_Export.xlsx');
}

function fpClear() {
    fpExtractedData=[]; fpUploadedFiles=[];
    document.getElementById('fpResultBody').innerHTML='';
    document.getElementById('fpFileInput').value='';
    document.getElementById('fpProcessBtn').disabled=true;
    document.getElementById('fpDownloadBtn').style.display='none';
    document.getElementById('fpClearBtn').style.display='none';
    document.getElementById('fpResultSection').style.display='none';
    document.getElementById('fpStatus').textContent='Belum ada file yang dipilih';
    document.getElementById('fpFileInfo').innerHTML='';
}

// CSS animation for loading spinner
const style = document.createElement('style');
style.textContent = `@keyframes spin { 0%{transform:rotate(0deg)} 100%{transform:rotate(360deg)} }`;
document.head.appendChild(style);

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  IMPORT EXCEL ‚Äî BATCH CALCULATOR
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

const IMP_CONFIG = {
    pph21_ter: {
        label: 'PPh 21 TER Bulanan',
        cols:  ['Nama', 'Kategori_PTKP', 'Penghasilan_Bruto'],
        notes: 'Kategori_PTKP: isi A, B, atau C\nA = TK/0, TK/1, K/0 | B = TK/2, TK/3, K/1, K/2 | C = K/3\nPenghasilan_Bruto: nominal bulanan (angka, tanpa titik/koma)',
        resultCols: ['Nama', 'Kategori_PTKP', 'Penghasilan_Bruto', 'Tarif_TER_%', 'PPh21_Dipotong', 'Nett_Diterima'],
    },
    pph21_tetap: {
        label: 'PPh 21 Tarif Tetap',
        cols:  ['Nama', 'Tarif_%', 'DPP'],
        notes: 'Tarif_%: isi 0.5, 2.5, atau 5\nDPP: nilai dasar pengenaan pajak (angka)',
        resultCols: ['Nama', 'Tarif_%', 'DPP', 'PPh21_Dipotong', 'Nett_Diterima'],
    },
    pph21_progresif: {
        label: 'PPh 21 Progresif Tahunan',
        cols:  ['Nama', 'PKP_Setahun', 'Status_NPWP'],
        notes: 'PKP_Setahun: Penghasilan Kena Pajak setahun (angka)\nStatus_NPWP: isi NPWP atau NON-NPWP',
        resultCols: ['Nama', 'PKP_Setahun', 'Status_NPWP', 'PPh21_Terutang', 'Tarif_Efektif_%', 'PPh21_Per_Bulan'],
    },
    pph23: {
        label: 'PPh 23',
        cols:  ['Nama', 'Jenis_Penghasilan', 'DPP'],
        notes: 'Jenis_Penghasilan: Dividen/Bunga/Royalti (2%), Jasa (2%), Sewa (2%), atau custom tarif angka misal 1.5\nDPP: nilai bruto (angka)',
        resultCols: ['Nama', 'Jenis_Penghasilan', 'DPP', 'Tarif_%', 'PPh23_Dipotong', 'Nett_Diterima'],
    },
    pph4: {
        label: 'PPh 4(2)',
        cols:  ['Nama', 'Jenis_Penghasilan', 'DPP'],
        notes: 'Jenis_Penghasilan: Sewa_Tanah (10%), Bunga_Deposito (20%), Konstruksi_Kecil (1.75%), Konstruksi_Menengah (2.65%), Konstruksi_Tanpa_SBU (4%), Perencanaan_SBU (3.5%), Perencanaan_NonSBU (6%), Pengalihan_Tanah (2.5%), atau custom tarif angka misal 10\nDPP: nilai bruto (angka)',
        resultCols: ['Nama', 'Jenis_Penghasilan', 'DPP', 'Tarif_%', 'PPh4_Dipotong', 'Nett_Diterima'],
    },
    pph22: {
        label: 'PPh 22',
        cols:  ['Nama', 'Jenis_Pemungutan', 'Nilai_Transaksi'],
        notes: 'Jenis_Pemungutan: Bendaharawan (1.5%), Impor_Bebas (0.25%), Impor_Lain (2.5%), Impor_Mewah (7.5%), BBM (0.1%), Semen (0.3%), Kertas (0.45%), Baja (0.3%), Otomotif (0.25%), Farmasi (0.3%), atau custom tarif angka\nNilai_Transaksi: angka',
        resultCols: ['Nama', 'Jenis_Pemungutan', 'Nilai_Transaksi', 'Tarif_%', 'PPh22_Dipungut'],
    },
    ppn: {
        label: 'PPN',
        cols:  ['Nama', 'Tarif_%', 'DPP'],
        notes: 'Tarif_%: isi 12, 11, 1, 2.2, atau angka lain\nDPP: nilai dasar pengenaan pajak (angka, belum termasuk PPN)',
        resultCols: ['Nama', 'Tarif_%', 'DPP', 'DPP_Nilai_Lain', 'PPN_Terutang', 'Total_Tagihan'],
    },
    pph15: {
        label: 'PPh 15',
        cols:  ['Nama', 'Jenis_WP', 'Peredaran_Bruto'],
        notes: 'Jenis_WP: Pelayaran_DN (1.2%), Pelayaran_LN (2.64%), Penerbangan_DN (1.8%), atau custom tarif angka\nPeredaran_Bruto: angka',
        resultCols: ['Nama', 'Jenis_WP', 'Peredaran_Bruto', 'Tarif_%', 'PPh15_Dipotong', 'Nett_Diterima'],
    },
};

let impResultData = [];
let impCurrentJenis = 'pph21_ter';

function impUpdateInfo() {
    impCurrentJenis = document.getElementById('imp_jenis').value;
    const cfg = IMP_CONFIG[impCurrentJenis];
    document.getElementById('imp_info').innerHTML =
        `<strong>Kolom yang dibutuhkan:</strong> ${cfg.cols.join(', ')}<br><br>${cfg.notes.replace(/\n/g,'<br>')}`;
    // Reset result
    impResultData = [];
    document.getElementById('impResultSection').style.display = 'none';
    document.getElementById('impFileInfo').style.display = 'none';
    document.getElementById('impErrorBox').style.display = 'none';
    document.getElementById('impFileInput').value = '';
}

function impDownloadTemplate() {
    const jenis = document.getElementById('imp_jenis').value;
    const cfg = IMP_CONFIG[jenis];
    const wb = XLSX.utils.book_new();
    // Header row
    const ws_data = [cfg.cols];
    // Sample rows
    const samples = impGetSamples(jenis);
    samples.forEach(s => ws_data.push(s));
    const ws = XLSX.utils.aoa_to_sheet(ws_data);
    // Column widths
    ws['!cols'] = cfg.cols.map(() => ({wch: 28}));
    // Style header (bold) via cell metadata isn't supported without xlsx-style, but set ref
    XLSX.utils.book_append_sheet(wb, ws, 'Data_Input');
    // Info sheet
    const ws_info = XLSX.utils.aoa_to_sheet([
        ['Petunjuk Pengisian'],
        [''],
        ['Jenis Perhitungan:', cfg.label],
        [''],
        ['Kolom yang wajib diisi:'],
        ...cfg.cols.map((c,i) => [c + ':', '']),
        [''],
        ['Catatan:'],
        ...cfg.notes.split('\n').map(n => [n]),
        [''],
        ['Hapus baris contoh sebelum upload. Baris 1 (header) JANGAN dihapus.'],
    ]);
    ws_info['!cols'] = [{wch:40},{wch:50}];
    XLSX.utils.book_append_sheet(wb, ws_info, 'Petunjuk');
    XLSX.writeFile(wb, `Template_${jenis}_PajakTools.xlsx`);
}

function impGetSamples(jenis) {
    const map = {
        pph21_ter:        [['Budi Santoso','A','8000000'],['Sari Dewi','B','15000000'],['Andi Pratama','C','25000000']],
        pph21_tetap:      [['Budi Santoso','2.5','5000000'],['Sari Dewi','0.5','10000000']],
        pph21_progresif:  [['Budi Santoso','300000000','NPWP'],['Sari Dewi','600000000','NON-NPWP']],
        pph23:            [['PT Maju','Dividen/Bunga/Royalti','50000000'],['CV Sukses','Jasa','20000000']],
        pph4:             [['PT Maju','Sewa_Tanah','100000000'],['Budi','Konstruksi_Kecil','500000000']],
        pph22:            [['PT Maju','Bendaharawan','200000000'],['CV ABC','Impor_Lain','50000000']],
        ppn:              [['Invoice A','12','10000000'],['Invoice B','11','5000000']],
        pph15:            [['PT Kapal','Pelayaran_DN','1000000000'],['PT Udara','Penerbangan_DN','500000000']],
    };
    return map[jenis] || [];
}

function impHandleFile(input) {
    const file = input.files[0];
    if (!file) return;
    document.getElementById('impErrorBox').style.display = 'none';
    document.getElementById('impResultSection').style.display = 'none';
    document.getElementById('impFileInfo').style.display = 'block';
    document.getElementById('impFileInfo').textContent = `üìÇ ${file.name} (${(file.size/1024).toFixed(1)} KB) ‚Äî Memproses...`;

    const reader = new FileReader();
    reader.onload = e => {
        try {
            const wb = XLSX.read(e.target.result, {type:'binary'});
            const ws = wb.Sheets[wb.SheetNames[0]];
            const raw = XLSX.utils.sheet_to_json(ws, {header:1, defval:''});
            if (raw.length < 2) { impShowError('File kosong atau tidak ada data selain header.'); return; }

            const headers = raw[0].map(h => String(h).trim());
            const rows = raw.slice(1).filter(r => r.some(c => c !== ''));
            if (rows.length === 0) { impShowError('Tidak ada data yang ditemukan (selain baris header).'); return; }

            // Process
            const jenis = document.getElementById('imp_jenis').value;
            const results = impProcess(jenis, headers, rows);
            if (!results) return;

            impResultData = results;
            impRenderPreview(jenis, results);
            document.getElementById('impFileInfo').textContent = `‚úÖ ${file.name} ‚Äî ${rows.length} baris diproses`;
        } catch(err) {
            impShowError('Gagal membaca file: ' + err.message);
        }
    };
    reader.readAsBinaryString(file);

    // Setup drag & drop area
    const area = document.getElementById('impUploadArea');
    area.classList.add('success');
    setTimeout(() => area.classList.remove('success'), 2000);
}

function impShowError(msg) {
    const el = document.getElementById('impErrorBox');
    el.style.display = 'block';
    el.textContent = '‚ùå ' + msg;
    document.getElementById('impFileInfo').style.display = 'none';
}

function impFindCol(headers, ...candidates) {
    for (const c of candidates) {
        const idx = headers.findIndex(h => h.toLowerCase().replace(/\s+/g,'_') === c.toLowerCase().replace(/\s+/g,'_'));
        if (idx >= 0) return idx;
    }
    return -1;
}

function impParseNum(v) { return parseFloat(String(v).replace(/\./g,'').replace(',','.')) || 0; }
function impFmt(n)      { return Math.round(n).toLocaleString('id-ID'); }

function impProcess(jenis, headers, rows) {
    const cfg = IMP_CONFIG[jenis];
    const results = [];

    if (jenis === 'pph21_ter') {
        const iNama  = impFindCol(headers,'Nama');
        const iKat   = impFindCol(headers,'Kategori_PTKP','Kategori');
        const iBruto = impFindCol(headers,'Penghasilan_Bruto','Bruto');
        if (iNama<0||iKat<0||iBruto<0) { impShowError(`Kolom tidak ditemukan. Pastikan header: ${cfg.cols.join(', ')}`); return null; }
        rows.forEach((r,i) => {
            const nama  = r[iNama] || `Baris ${i+2}`;
            const kat   = String(r[iKat]).trim().toUpperCase();
            const bruto = impParseNum(r[iBruto]);
            const tarif = getTerRate(['A','B','C'].includes(kat)?kat:'A', bruto);
            const pajak = Math.round(bruto * tarif / 100);
            results.push([nama, kat, impFmt(bruto), tarif.toFixed(2)+'%', impFmt(pajak), impFmt(bruto-pajak)]);
        });
    }
    else if (jenis === 'pph21_tetap') {
        const iNama  = impFindCol(headers,'Nama');
        const iTarif = impFindCol(headers,'Tarif_%','Tarif');
        const iDpp   = impFindCol(headers,'DPP');
        if (iNama<0||iTarif<0||iDpp<0) { impShowError(`Kolom tidak ditemukan. Pastikan header: ${cfg.cols.join(', ')}`); return null; }
        rows.forEach((r,i) => {
            const nama  = r[iNama] || `Baris ${i+2}`;
            const tarif = parseFloat(r[iTarif]) || 0;
            const dpp   = impParseNum(r[iDpp]);
            const pajak = dpp * tarif / 100;
            results.push([nama, tarif+'%', impFmt(dpp), impFmt(pajak), impFmt(dpp-pajak)]);
        });
    }
    else if (jenis === 'pph21_progresif') {
        const iNama  = impFindCol(headers,'Nama');
        const iPkp   = impFindCol(headers,'PKP_Setahun','PKP');
        const iNpwp  = impFindCol(headers,'Status_NPWP','NPWP');
        if (iNama<0||iPkp<0||iNpwp<0) { impShowError(`Kolom tidak ditemukan. Pastikan header: ${cfg.cols.join(', ')}`); return null; }
        rows.forEach((r,i) => {
            const nama  = r[iNama] || `Baris ${i+2}`;
            const pkp   = impParseNum(r[iPkp]);
            const npwp  = String(r[iNpwp]).trim().toUpperCase();
            const mult  = npwp === 'NON-NPWP' ? 1.2 : 1;
            let rem = pkp, total = 0;
            PROG_LAYERS.forEach(l => {
                const taxable = Math.min(rem, l.cap);
                total += taxable > 0 ? taxable * l.rate : 0;
                rem -= taxable;
            });
            const finalPph = total * mult;
            const efektif  = pkp > 0 ? (finalPph/pkp*100).toFixed(2) : '0';
            results.push([nama, impFmt(pkp), npwp, impFmt(finalPph), efektif+'%', impFmt(finalPph/12)]);
        });
    }
    else if (jenis === 'pph23') {
        const iNama  = impFindCol(headers,'Nama');
        const iJenis = impFindCol(headers,'Jenis_Penghasilan','Jenis');
        const iDpp   = impFindCol(headers,'DPP');
        if (iNama<0||iJenis<0||iDpp<0) { impShowError(`Kolom tidak ditemukan. Pastikan header: ${cfg.cols.join(', ')}`); return null; }
        const tarifMap23 = {'dividen':2,'bunga':2,'royalti':2,'jasa':2,'sewa':2};
        rows.forEach((r,i) => {
            const nama  = r[iNama] || `Baris ${i+2}`;
            const jns   = String(r[iJenis]).trim();
            const dpp   = impParseNum(r[iDpp]);
            // Try parse as number first (custom tarif)
            let tarif = parseFloat(jns);
            if (isNaN(tarif)) tarif = tarifMap23[jns.toLowerCase().split('/')[0]] || 2;
            const pajak = dpp * tarif / 100;
            results.push([nama, jns, impFmt(dpp), tarif+'%', impFmt(pajak), impFmt(dpp-pajak)]);
        });
    }
    else if (jenis === 'pph4') {
        const iNama  = impFindCol(headers,'Nama');
        const iJenis = impFindCol(headers,'Jenis_Penghasilan','Jenis');
        const iDpp   = impFindCol(headers,'DPP');
        if (iNama<0||iJenis<0||iDpp<0) { impShowError(`Kolom tidak ditemukan. Pastikan header: ${cfg.cols.join(', ')}`); return null; }
        const tarifMap4 = {
            'sewa_tanah':10,'bunga_deposito':20,'konstruksi_kecil':1.75,'konstruksi_menengah':2.65,
            'konstruksi_tanpa_sbu':4,'perencanaan_sbu':3.5,'perencanaan_nonsbu':6,'pengalihan_tanah':2.5,
        };
        rows.forEach((r,i) => {
            const nama  = r[iNama] || `Baris ${i+2}`;
            const jns   = String(r[iJenis]).trim();
            const dpp   = impParseNum(r[iDpp]);
            let tarif = parseFloat(jns);
            if (isNaN(tarif)) tarif = tarifMap4[jns.toLowerCase()] || 10;
            const pajak = dpp * tarif / 100;
            results.push([nama, jns, impFmt(dpp), tarif+'%', impFmt(pajak), impFmt(dpp-pajak)]);
        });
    }
    else if (jenis === 'pph22') {
        const iNama  = impFindCol(headers,'Nama');
        const iJenis = impFindCol(headers,'Jenis_Pemungutan','Jenis');
        const iNilai = impFindCol(headers,'Nilai_Transaksi','Nilai','DPP');
        if (iNama<0||iJenis<0||iNilai<0) { impShowError(`Kolom tidak ditemukan. Pastikan header: ${cfg.cols.join(', ')}`); return null; }
        const tarifMap22 = {
            'bendaharawan':1.5,'impor_bebas':0.25,'impor_lain':2.5,'impor_mewah':7.5,
            'bbm':0.1,'semen':0.3,'kertas':0.45,'baja':0.3,'otomotif':0.25,'farmasi':0.3,
        };
        rows.forEach((r,i) => {
            const nama  = r[iNama] || `Baris ${i+2}`;
            const jns   = String(r[iJenis]).trim();
            const nilai = impParseNum(r[iNilai]);
            let tarif = parseFloat(jns);
            if (isNaN(tarif)) tarif = tarifMap22[jns.toLowerCase()] || 1.5;
            const pajak = nilai * tarif / 100;
            results.push([nama, jns, impFmt(nilai), tarif+'%', impFmt(pajak)]);
        });
    }
    else if (jenis === 'ppn') {
        const iNama  = impFindCol(headers,'Nama');
        const iTarif = impFindCol(headers,'Tarif_%','Tarif');
        const iDpp   = impFindCol(headers,'DPP');
        if (iNama<0||iTarif<0||iDpp<0) { impShowError(`Kolom tidak ditemukan. Pastikan header: ${cfg.cols.join(', ')}`); return null; }
        rows.forEach((r,i) => {
            const nama  = r[iNama] || `Baris ${i+2}`;
            const tarif = parseFloat(r[iTarif]) || 12;
            const dpp   = impParseNum(r[iDpp]);
            const dppNL = tarif === 12 ? dpp * 11/12 : dpp;
            const ppn   = dppNL * tarif / 100;
            const total = dpp + ppn;
            results.push([nama, tarif+'%', impFmt(dpp), impFmt(dppNL), impFmt(ppn), impFmt(total)]);
        });
    }
    else if (jenis === 'pph15') {
        const iNama  = impFindCol(headers,'Nama');
        const iJenis = impFindCol(headers,'Jenis_WP','Jenis');
        const iBruto = impFindCol(headers,'Peredaran_Bruto','Bruto');
        if (iNama<0||iJenis<0||iBruto<0) { impShowError(`Kolom tidak ditemukan. Pastikan header: ${cfg.cols.join(', ')}`); return null; }
        const tarifMap15 = {'pelayaran_dn':1.2,'pelayaran_ln':2.64,'penerbangan_dn':1.8};
        rows.forEach((r,i) => {
            const nama  = r[iNama] || `Baris ${i+2}`;
            const jns   = String(r[iJenis]).trim();
            const bruto = impParseNum(r[iBruto]);
            let tarif = parseFloat(jns);
            if (isNaN(tarif)) tarif = tarifMap15[jns.toLowerCase()] || 1.2;
            const pajak = bruto * tarif / 100;
            results.push([nama, jns, impFmt(bruto), tarif+'%', impFmt(pajak), impFmt(bruto-pajak)]);
        });
    }

    return results;
}

function impRenderPreview(jenis, results) {
    const cfg    = IMP_CONFIG[jenis];
    const thead  = document.getElementById('impPreviewHead');
    const tbody  = document.getElementById('impPreviewBody');
    const total  = results.length;

    thead.innerHTML = `<tr style="background:linear-gradient(135deg,#1e3a5f,#263548);">
        <th style="padding:9px 12px;text-align:left;font-family:'IBM Plex Mono',monospace;font-size:10px;color:var(--text-muted);text-transform:uppercase;">#</th>
        ${cfg.resultCols.map(c => `<th style="padding:9px 12px;text-align:left;font-family:'IBM Plex Mono',monospace;font-size:10px;color:var(--accent2);text-transform:uppercase;white-space:nowrap;">${c.replace(/_/g,' ')}</th>`).join('')}
    </tr>`;

    const preview = results.slice(0, 50);
    tbody.innerHTML = preview.map((row, i) => `
        <tr style="${i%2===1?'background:rgba(255,255,255,0.02)':''}">
            <td style="padding:8px 12px;color:var(--text-muted);font-family:'IBM Plex Mono',monospace;font-size:11px;">${i+1}</td>
            ${row.map((v,ci) => `<td style="padding:8px 12px;color:var(--text);font-size:12px;white-space:nowrap;${ci>=2?'font-family:\'IBM Plex Mono\',monospace;text-align:right;':''}">${v}</td>`).join('')}
        </tr>`).join('');

    document.getElementById('impSummaryBadge').textContent = `${total} baris ¬∑ ${cfg.label}`;
    document.getElementById('impResultSection').style.display = 'block';
}

function impDownloadResult() {
    if (!impResultData.length) return;
    const jenis = document.getElementById('imp_jenis').value;
    const cfg   = IMP_CONFIG[jenis];
    const wb    = XLSX.utils.book_new();

    // Result sheet
    const ws_data = [cfg.resultCols, ...impResultData];
    const ws = XLSX.utils.aoa_to_sheet(ws_data);
    ws['!cols'] = cfg.resultCols.map(() => ({wch: 24}));

    // Apply number formatting to numeric columns (col index >= 2, skip %, skip text)
    const range = XLSX.utils.decode_range(ws['!ref']);
    for (let R = 1; R <= range.e.r; R++) {
        for (let C = 2; C <= range.e.c; C++) {
            const addr = XLSX.utils.encode_cell({r:R,c:C});
            const cell = ws[addr];
            if (!cell) continue;
            const val  = String(cell.v).replace(/\./g,'').replace(',','.');
            const num  = parseFloat(val);
            if (!isNaN(num) && !String(cell.v).includes('%')) {
                ws[addr] = {t:'n', v:num, z:'#,##0'};
            }
        }
    }

    XLSX.utils.book_append_sheet(wb, ws, 'Hasil_Perhitungan');

    // Summary sheet
    const now = new Date().toLocaleString('id-ID');
    const ws_sum = XLSX.utils.aoa_to_sheet([
        ['Hasil Perhitungan Pajak ‚Äî PajakTools'],
        [''],
        ['Jenis Perhitungan:', cfg.label],
        ['Jumlah Data:', impResultData.length],
        ['Tanggal Proses:', now],
        [''],
        ['Generated by PajakTools'],
    ]);
    ws_sum['!cols'] = [{wch:30},{wch:40}];
    XLSX.utils.book_append_sheet(wb, ws_sum, 'Info');

    XLSX.writeFile(wb, `Hasil_${jenis}_${Date.now()}.xlsx`);
}

// Init import info on load
document.addEventListener('DOMContentLoaded', () => {
    impUpdateInfo();
    // Drag & drop for import upload area
    const area = document.getElementById('impUploadArea');
    if (area) {
        area.addEventListener('dragover', e => { e.preventDefault(); area.classList.add('dragover'); });
        area.addEventListener('dragleave', () => area.classList.remove('dragover'));
        area.addEventListener('drop', e => {
            e.preventDefault();
            area.classList.remove('dragover');
            const file = e.dataTransfer.files[0];
            if (file) {
                const dt = new DataTransfer();
                dt.items.add(file);
                document.getElementById('impFileInput').files = dt.files;
                impHandleFile(document.getElementById('impFileInput'));
            }
        });
    }
});
</script>
</body>
</html>
